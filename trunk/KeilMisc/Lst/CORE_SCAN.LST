C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 1   


C51 COMPILER V8.12, COMPILATION OF MODULE CORE_SCAN
OBJECT MODULE PLACED IN Code\CORE\CORE_SCAN.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Code\CORE\CORE_SCAN.C LA WL(1) CD OT(9,SIZE) NOAREGS OR INCDIR(.\Code\CORE\
                    -INCLUDE\;.\Code\OEM\INCLUDE\;.\Code\CHIP\INCLUDE\)

line level    source

   1          /*-----------------------------------------------------------------------------
   2           * TITLE: CORE_SCN.C - code to handle local keyboard scanning.
   3           *
   4           * Copyright (c) 1983-2007, Insyde Software Corporation. All Rights Reserved.
   5           *
   6           * You may not reproduce, distribute, publish, display, perform, modify, adapt,
   7           * transmit, broadcast, present, recite, release, license or otherwise exploit
   8           * any part of this publication in any form, by any means, without the prior
   9           * written permission of Insyde Software Corporation.
  10           *---------------------------------------------------------------------------*/
  11          
  12          #include <CORE_INCLUDE.H>
  13          #include <OEM_INCLUDE.H>
  14          
  15          void CapDelay(void)
  16          {
  17   1          WNCKR = 0x00;               // Delay 15.26 us
  18   1          //WNCKR = 0x00;               // Delay 15.26 us
  19   1      }
  20          
  21          /* ----------------------------------------------------------------------------
  22           * FUNCTION:   scan_keys
  23           *
  24           * Scan key matrix once.
  25           *
  26           * Return: value != 0, scan activity detected, scan again later.
  27           *         value  = 0, no scan activity detected.
  28           * ------------------------------------------------------------------------- */
  29          BYTE scan_keys(void)
  30          {
  31   1              BYTE result;
  32   1              result = FALSE;
  33   1      
  34   1          scan.saf_make = 0;
  35   1          scan.saf_break = 0;
  36   1          scan.saf_keys = 0;
  37   1      
  38   1              if (typematic.byte)
  39   1              {
  40   2              check_tm(typematic);    // Check typematic.
  41   2              }
  42   1      
  43   1              if (new_keyh.byte)              // Exist Debounce key?
  44   1              {                                               // Yes, bounding.
  45   2              scan.saf_make = 1;      // Set debounce make bit.
  46   2              debounce_key();
  47   2              result = TRUE;
  48   2              }
  49   1      
  50   1          if (!result)                                // Otherwise, scan all.
  51   1          {
  52   2              for (ITempB03=0;ITempB03<16;ITempB03++)
  53   2              {
  54   3                      Write_Strobe(ITempB03);
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 2   

  55   3                              CapDelay();
  56   3                      ITempB02 = KSI;         // Read in KI 0 - 7 sense line data. */
  57   3                  ITempB02 = (~ITempB02) ^ bscan_matrix[ITempB03];
  58   3                  if (ITempB02 != 0)
  59   3                      {
  60   4                      check_scan(ITempB02, ITempB03);
  61   4                      }
  62   3      
  63   3                  if (bscan_matrix[ITempB03])
  64   3                      {                                                       // Here, if current still active.
  65   4                      scan.saf_keys = 1;      // Set keys active bits. Check all key release.
  66   4                  }
  67   3                              KSOL=0xFF;
  68   3                              KSOH1=0xFF;
  69   3                              KSOH2 = 0xFF;
  70   3              }
  71   2                                                                              // If ghost exist, make key clear.
  72   2              if (new_keyl.field.ghost == 1)
  73   2              {
  74   3                  new_keyl.field.ghost = 0;   // Ghost flag is set. Clear it.
  75   3                  ITempB01 = new_keyl.byte & 7;
  76   3                  if (ITempB01 == 0)
  77   3                  {
  78   4                      ITempB01 = Byte_Mask((BYTE) (new_keyh.field.input));
  79   4                      ITempB01 = ITempB01 & diode_key;
  80   4                  }
  81   3      
  82   3                  if (ITempB01 == 0)
  83   3                  {
  84   4                      new_keyh.byte = 0;      // Clear new key.
  85   4                      new_keyl.byte = 0;
  86   4                  }
  87   3              }
  88   2          }
  89   1      
  90   1              return((BYTE) (scan.saf_make + scan.saf_break + scan.saf_keys));
  91   1      }
  92          
  93          /* ----------------------------------------------------------------------------
  94           * FUNCTION: Write_Strobe
  95           *
  96           * Writes the scan matrix KSO[15:0] lines based on Scan Line bit number.
  97           *
  98           * KSO[15:0] will be all floats or open except for the bit corresponding to
  99           * the Scan Line number.  This bit will be low to be detected by the sense
 100           * line input port later.
 101           *
 102           * Config.Msk_Strobe_H and Config.Msk_Strobe_L specify which of the 16 bits on
 103           * the port are used for the scanner.  (1 = Scanner, 0 = Other OEM function).
 104           * This allows port pins which are not used for the scanner output lines to be
 105           * used for something else.
 106           *
 107           * Input: Scan line number.
 108           * ------------------------------------------------------------------------- */
 109          void Write_Strobe(BYTE scan_line_num)
 110          {
 111   1              if (scan_line_num<8)
 112   1              {
 113   2              KSOL=~(0x01<<scan_line_num);
 114   2              KSOH1=0xFF;
 115   2              }
 116   1              else
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 3   

 117   1              {
 118   2              KSOL=0xFF;
 119   2                      KSOH1=~(0x01<<(scan_line_num-0x08));
 120   2              }
 121   1      
 122   1              if(ExtendMatrix)
 123   1              {
 124   2                      KSOH2 = 0xFF;
 125   2                      Hook_SetGPIOScanPinH();
 126   2              }
 127   1      }
 128          
 129          /* ----------------------------------------------------------------------------
 130           * FUNCTION: check_scan
 131           *
 132           * Input:
 133           *     changes = Any bit set indicates there is a difference in state from
 134           *         last KSI to this KSI.
 135           *     scan_address = Address of strobe line that was low when changes was
 136           *         computed.
 137           *
 138           * NOTE:  For the shift and bit test of "changes" to work, "changes" MUST be
 139           * unsigned.  (Right shifting an unsigned quantity fills vacated bits with
 140           * zeros.  Right shifting a signed quantity will fill vacated bits with sign
 141           * bits on some machines and zero bits on others.)
 142           * ------------------------------------------------------------------------- */
 143          static void check_scan(BYTE changes, BYTE scan_address)
 144          {
 145   1          BYTE flag;
 146   1          BYTE change_make_key;
 147   1          BYTE bit_num;
 148   1      
 149   1              flag = FALSE;                                   // Simple Matrix.
 150   1              if (new_keyl.field.ghost == 1)
 151   1              {
 152   2              flag = TRUE;
 153   2              }
 154   1              else
 155   1              {   /* Find 0 -> 1 's. */
 156   2                      change_make_key = changes & ~bscan_matrix[scan_address];
 157   2              if (change_make_key == 0)
 158   2                      {
 159   3                      flag = FALSE;
 160   3              }
 161   2                      else if (find_paths(change_make_key, scan_address))
 162   2                      {
 163   3                      flag = TRUE;    /* TRUE if ghost keys. */
 164   3              }
 165   2              }
 166   1      
 167   1              if (flag)
 168   1              {   /* Ghost exists. */
 169   2                      new_keyl.field.ghost = 1;  /* Set ghost flag. */
 170   2              /* Only look at 1 -> 0 transition & diode key always no ghost. */
 171   2              changes &= bscan_matrix[scan_address] | diode_key;
 172   2              }
 173   1      
 174   1          bit_num = 0;
 175   1          while (changes != 0)
 176   1          {
 177   2              if (changes & 0x01)     /* Look at changes 1 bit at a time. */
 178   2                      {
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 4   

 179   3                  cscfnd(bit_num, scan_address);
 180   3              }
 181   2              bit_num++;
 182   2              changes = changes >> 1; /* Shift bit out (and a zero bit in) to check next bit. */
 183   2          }
 184   1      }
 185          
 186          /* ----------------------------------------------------------------------------
 187           * FUNCTION:   cscfnd
 188           *
 189           * Find changed bit.  This subroutine is called for each bit in this KSI that
 190           * is different from last KSI.
 191           * ------------------------------------------------------------------------- */
 192          static void cscfnd(BYTE bit_num, BYTE scan_address)
 193          {
 194   1          if (bscan_matrix[scan_address] & Byte_Mask(bit_num))
 195   1          {
 196   2              if (scan.saf_break == 0)
 197   2                      {
 198   3                  scan.saf_break = 1;
 199   3                  setup_debounce(bit_num, scan_address, BREAK_EVENT);
 200   3              }
 201   2          }
 202   1          else
 203   1          {
 204   2              if (scan.saf_make == 0)
 205   2                      {
 206   3                  scan.saf_make = 1;
 207   3                  setup_debounce(bit_num, scan_address, MAKE_EVENT);
 208   3              }
 209   2          }
 210   1      }
 211          
 212          /* ----------------------------------------------------------------------------
 213           * FUNCTION:   setup_debounce
 214           *
 215           * Input:
 216           *     scan_address = number of bit of KO.
 217           *     bit_num = number of bit that changed from last KI to this KI for KO.
 218           *     event = contact event (MAKE_EVENT or BREAK_EVENT).
 219           * ------------------------------------------------------------------------- */
 220          static void setup_debounce(BYTE bit_num, BYTE scan_address, BYTE event)
 221          {
 222   1          new_keyh.field.output = scan_address;
 223   1          new_keyh.field.input = bit_num;
 224   1          new_keyh.field.debounce_status = 1;
 225   1          new_keyl.field.state = 0;  /* Debounce has not counted out. */
 226   1          new_keyl.field.same = 0;   /* Key activity indication. */
 227   1      
 228   1          if (event == MAKE_EVENT)
 229   1          {   /* For MAKE key (key pressed). */
 230   2              new_keyl.field.trans = 0;
 231   2              new_keyl.field.count = Ext_Cb2.field.Break_Count; /* Shouldn't this be Make_Count? */
 232   2          }
 233   1          else
 234   1          {   /* For BREAK key (key released). */
 235   2              new_keyl.field.trans = 1;
 236   2              new_keyl.field.count = Ext_Cb2.field.Make_Count; /* Shouldn't this be Break_Count? */
 237   2          }
 238   1      }
 239          
 240          /* ----------------------------------------------------------------------------
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 5   

 241           * FUNCTION: find_paths
 242           *
 243           * Input:  DOWN_STATE  scan_address
 244           *         change_make_key
 245           *
 246           * Return: FALSE if no paths found, Otherwise returns TRUE.
 247           * ------------------------------------------------------------------------- */
 248          static FLAG find_paths(BYTE change_make_key, BYTE scan_address)
 249          {
 250   1          FLAG paths_found, done;
 251   1          BYTE paths, temp, bits;
 252   1          BYTE first_address;
 253   1      
 254   1          /* For the shift and bit test to work, "bits" MUST be unsigned.  (Right
 255   1             shifting an unsigned quantity fills vacated bits with zeros.  Right
 256   1             shifting a signed quantity will fill vacated bits with sign bits on some
 257   1             machines and zero bits on others.) */
 258   1          done = FALSE;
 259   1          paths_found = FALSE;
 260   1          first_address = scan_address;
 261   1      
 262   1          change_make_key &= ~(diode_key); /* Ignore diode key. */
 263   1          /* change_make_key = bKO_BITS. */
 264   1      
 265   1          if (change_make_key == 0)
 266   1              {
 267   2              done = TRUE; /* paths_found == FALSE */
 268   2          }
 269   1      
 270   1          if (!done)
 271   1          {
 272   2              paths = bscan_matrix[scan_address] | change_make_key;
 273   2              paths &= ~(diode_key);  /* Ignore diode key. */
 274   2              /* paths = bKO_PATHS. */
 275   2              if (paths == 0)
 276   2                      {
 277   3                  done = TRUE;  /* paths_found == FALSE */
 278   3              }
 279   2          }
 280   1      
 281   1          while (!done)
 282   1          {
 283   2              scan_address++;
 284   2      
 285   2              if (scan_address >= MAX_SCAN_LINES)
 286   2              //if(scan_address >= STANDARD_SCAN_LINES)
 287   2                      {
 288   3                  scan_address = 0;   /* Wrap around */
 289   3              }
 290   2      
 291   2              if (scan_address == first_address)
 292   2                      {
 293   3                  done = TRUE;        /* No scan lines left.  paths_found == FALSE */
 294   3              }
 295   2      
 296   2              if (!done)
 297   2              {   /* Check Path */
 298   3                  temp  = bscan_matrix[scan_address]; /* Any paths? */
 299   3                  temp &= ~(diode_key);               /* Ignore diode key */
 300   3      
 301   3                  if (temp != 0)
 302   3                              {    /* Paths found */
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 6   

 303   4                      temp &= paths;  /* Do paths line up? */
 304   4                  }
 305   3      
 306   3                  if (temp != 0)
 307   3                  {   /* Paths line up */
 308   4                      if (change_make_key != temp)  /* Only 1 bit set? */
 309   4                      {   /* No, ghost exists. */
 310   5                          paths_found = TRUE;
 311   5                          done = TRUE;
 312   5                      }
 313   4      
 314   4                      if (!done)
 315   4                      {   /* The following checks if more than one bit is set to 1.
 316   5                                      Because "bits" is unsigned, each shift moves the bit
 317   5                                      under test out and a 0 bit in.  When the first 1 bit is
 318   5                                       found, if "bits" == 0, this indicates that there is only
 319   5                                      one bit set. */
 320   5                          bits = paths;  /* Only 1 bit set? */
 321   5                          temp = FALSE;
 322   5      
 323   5                          do
 324   5                          {
 325   6                              if (bits & 0x01)
 326   6                                                      {
 327   7                                  temp = TRUE;
 328   7                              }
 329   6      
 330   6                              /* Shift bit out (and a zero bit in) to check next bit. */
 331   6                              bits = bits >> 1;
 332   6                          } while (temp == FALSE);
 333   5      
 334   5                          if (bits != 0)
 335   5                          {   /* No, more than 1 bit set. */
 336   6                              paths_found = TRUE;
 337   6                              done = TRUE;
 338   6                          }
 339   5                      } /* if (!done) */
 340   4                  } /* if (temp != 0) */
 341   3              } /* if (!done) */
 342   2          } /* while (!done) */
 343   1      
 344   1         return (paths_found);
 345   1      }
 346          
 347          /* ----------------------------------------------------------------------------
 348           * FUNCTION: debounce_key
 349           * ------------------------------------------------------------------------- */
 350          static void debounce_key(void)
 351          {
 352   1          scan.scan_line = new_keyh.field.output;
 353   1          Write_Strobe(scan.scan_line);
 354   1              CapDelay();
 355   1          ITempB01 = Read_Scan_Lines();
 356   1          ITempB01 = ~ITempB01;
 357   1      
 358   1          ITempB02 = Byte_Mask((BYTE) (new_keyh.field.input));
 359   1          ITempB02 = ITempB02 & ITempB01;
 360   1      
 361   1          if (ITempB02 != 0)
 362   1          {
 363   2              if (new_keyl.field.trans == 0)
 364   2                      {
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 7   

 365   3                  new_keyl.field.same = 1;    // last key detected as a MAKE,  same = 1.
 366   3              }
 367   2              else
 368   2                      {
 369   3                  new_keyl.field.same = 0;    // last key detected as a BREAK, same = 0.
 370   3              }
 371   2          }
 372   1          else
 373   1          {
 374   2              if (new_keyl.field.trans == 0)
 375   2                      {
 376   3                  new_keyl.field.same = 0;    // last key detected as a MAKE,  same = 0.
 377   3              }
 378   2              else
 379   2                      {
 380   3                  new_keyl.field.same = 1;    // last key detected as a BREAK, same = 1.
 381   3              }
 382   2          }
 383   1      #if 0           // 0201 change keyboard debounce time to 5ms
                  if (new_keyl.field.state == 0)
                  {
                      if (new_keyl.field.count != 0)
                      {
                          new_keyl.field.count--;
                      }
                      else
                      {
                          if (new_keyl.field.same == 0)
                          {
                              new_keyh.byte = 0;      // Debounce failed, so claer all data
                              new_keyl.byte = 0;
                          }
                          else
                          {
                              new_keyl.field.state = 1;
                          }
                      }
                  }
                  else
              #endif
 405   1          {
 406   2              if (new_keyl.field.same == 0)
 407   2              {
 408   3                  new_keyh.byte = 0;  // Debounce failed.
 409   3                  new_keyl.byte = 0;
 410   3              }
 411   2              else
 412   2              {
 413   3                      change_valid();         // Debounce OK
 414   3              }
 415   2          }
 416   1      }
 417          
 418          /* ----------------------------------------------------------------
 419           * FUNCTION: Read_Scan_Lines - Read KSI[7:0] of the scan matrix
 420           *
 421           * Return: Data from sense lines that are enabled.
 422           *         The lines that are disabled return 1s.
 423           *
 424           * C prototype: BYTE Read_Scan_Lines();
 425           * ---------------------------------------------------------------- */
 426          BYTE Read_Scan_Lines(void)
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 8   

 427          {
 428   1              return (KSI);
 429   1      }
 430          
 431          /* ---------------------------------------------------------------
 432           * FUNCTION: change_valid
 433           * --------------------------------------------------------------- */
 434          static void change_valid(void)
 435          {
 436   1          ITempB04 = Byte_Mask((BYTE) (new_keyh.field.input));
 437   1          ITempB03 = bscan_matrix[new_keyh.field.output];
 438   1          ITempB03 = ITempB03 ^ ITempB04;
 439   1          bscan_matrix[new_keyh.field.output] = ITempB03;
 440   1      
 441   1              ITempB05 = BREAK_EVENT;                 // Ready for BREAK indication.
 442   1          if ((ITempB04 & ITempB03) != 0)
 443   1          {
 444   2              ITempB05 = MAKE_EVENT;
 445   2              typematic.byte = new_keyh.byte; // Set New Typematic Key.
 446   2              scan.TMscale = TM_SCALE;
 447   2              bTMcount = bTMdelay;
 448   2      
 449   2                      etkeytypematic.byte = 0x00;
 450   2          }
 451   1      
 452   1          Send_Scan2(new_keyh, ITempB05);
 453   1          new_keyh.byte = 0;
 454   1          new_keyl.byte = 0;
 455   1      }
 456          
 457          /* ----------------------------------------------------------------------------
 458           * FUNCTION: check_tm - Handle typematic function.
 459           *
 460           * Input: Typematic key
 461           * ------------------------------------------------------------------------- */
 462          static void check_tm(union KEY key)
 463          {
 464   1              ITempB02 = FALSE;
 465   1          ITempB01 = Byte_Mask((BYTE) (key.field.input));
 466   1          ITempB01 = ITempB01 & bscan_matrix[key.field.output];
 467   1      
 468   1          if (ITempB01 == 0)                  // Release Typematic key?
 469   1          {
 470   2              typematic.byte = 0;             // Clear Typematic.
 471   2              ITempB02 = TRUE;
 472   2          }
 473   1      
 474   1          if (!ITempB02)
 475   1          {
 476   2              scan.TMscale--;                 // Count down Prescale.
 477   2              if (scan.TMscale != 0)
 478   2                      {
 479   3                  ITempB02 = TRUE;
 480   3              }
 481   2          }
 482   1      
 483   1          if (!ITempB02)
 484   1          {
 485   2              scan.TMscale = TM_SCALE;// Reload prescale counter.
 486   2              bTMcount--;             // Count down TMcount.
 487   2              if (bTMcount != 0)
 488   2                      {
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 9   

 489   3                  ITempB02 = TRUE;
 490   3              }
 491   2          }
 492   1      
 493   1          if (!ITempB02)
 494   1          {
 495   2              bTMcount = bTMrepeat;   // Reload TMcount.
 496   2              Send_Scan2(key, REPEAT_EVENT);
 497   2          }
 498   1      }
 499          
 500          /* ----------------------------------------------------------------
 501           * FUNCTION: Scan_Init - Initialize internal keyboard (scanner)
 502           * ---------------------------------------------------------------- */
 503          void Scan_Init(void)                                    // Lower all KSO lines for scan matrix
 504          {
 505   1              KSOL=0x00;
 506   1              KSOH1=0x00;
 507   1      
 508   1              if(ExtendMatrix)                                // The function of extend keys
 509   1              {
 510   2                      KSOH2=0x00;
 511   2      
 512   2                      Hook_SetGPIOScanPinCtrl();
 513   2                      Hook_SetGPIOScanPinL();
 514   2              }
 515   1      }
 516          
 517          /* ----------------------------------------------------------------
 518           * FUNCTION: Enable_Any_Key_Irq
 519           *
 520           * Setup for any key from scanner to generate an interrupt.
 521           *
 522           * Lower the "strobe" lines so that when any key is pressed at least one input
 523           * line will go low.  Any bits (out of the possible 16) that are not used for
 524           * the internal keyboard (scanner) are left alone.  This is done using
 525           * Config.Msk_Strobe_H and Config.Msk_Strobe_L.
 526           *
 527           * Then, if the internal keyboard (scanner) is enabled, allow the interrupt to
 528           * occur when a key is pressed on the scanner.
 529           * -------------------------------------------------------------- */
 530          void Enable_Any_Key_Irq(void)   // Lower all KSO lines for scan matrix
 531          {
 532   1              KSOL=0x00;
 533   1              KSOH1=0x00;
 534   1      
 535   1              if (ExtendMatrix)
 536   1              {
 537   2                      KSOH2=0x00;
 538   2                      Hook_SetGPIOScanPinL();
 539   2              }
 540   1              SET_MASK(IER1,Int_KB);      // enable KSI interrupt
 541   1      }
 542          
 543          /* ----------------------------------------------------------------------------
 544           * FUNCTION:   Start_Scan_Transmission
 545           *
 546           * Lock out other devices so scanner can transmit data to Host, and start
 547           * Timer B with event "SEND_ENABLE".  When the "RESPONSE_TIME" has expired,
 548           * the Timer B interrupt handler will post a "SEND" service request to be
 549           * dispatched by the main service loop.  At that time the data will be sent to
 550           * the Host via the "SEND" service handler.
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 10  

 551           * ------------------------------------------------------------------------- */
 552          void Start_Scan_Transmission(void)
 553          {
 554   1          //Load_Timer_B();
 555   1          //Timer_B.fbit.SEND_ENABLE = 1;
 556   1          SetServiceSendFlag();
 557   1      }
 558          
 559          /* ----------------------------------------------------------------------------
 560           * FUNCTION:   Check_Scan_Transmission
 561           *
 562           * See if the scanner keyboard data transmission (to Host) should be allowed.
 563           *
 564           * Return: Transmission status indication.  TRUE if ok to transmit.
 565           * ------------------------------------------------------------------------- */
 566          FLAG Check_Scan_Transmission(void)
 567          {
 568   1          FLAG allow_transmission = FALSE;
 569   1      
 570   1          if ((Int_Var.Scan_Lock == 0) && (Flag.SCAN_INH == 0))
 571   1          {           /* Scanner transmission is locked and inhibited. */
 572   2      
 573   2              if (scan.kbf_head != scan.kbf_tail)
 574   2                      {
 575   3                  allow_transmission = TRUE;  /* Allow transmission */
 576   3              }
 577   2          }
 578   1      
 579   1          return (allow_transmission);
 580   1      }
 581          
 582          /* ----------------------------------------------------------------
 583           * FUNCTION: Get_Kbd_Type
 584           *
 585           * Returns the type of the internal keyboard.
 586           *
 587           * Returns: 0 = U.S. keyboard, 1 = Japanese keyboard.
 588           * -------------------------------------------------------------- */
 589          FLAG Get_Kbd_Type(void)
 590          {                                               // Check keyboard type here
 591   1                                                      // Returns: 0 = U.S. keyboard, 1 = Japanese keyboard.
 592   1              if(1)                           // check type here
 593   1              {
 594   2                      return(0);      // U.S. keyboard.
 595   2              }
 596   1              else
 597   1              {
 598   2                      return(1);              // Japanese keyboard
 599   2              }
 600   1      }
 601          
 602          /* ----------------------------------------------------------------------------
 603           * FUNCTION: Lock_Scan
 604           *
 605           * Lock out the scanner via "Scan_Lock" and clear pending scanner "SEND"
 606           * events.
 607           * ------------------------------------------------------------------------- */
 608          void Lock_Scan(void)
 609          {
 610   1          Int_Var.Scan_Lock = 1;
 611   1          //Timer_B.fbit.SEND_ENABLE = 0;
 612   1      }
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 11  

 613          
 614          /* ----------------------------------------------------------------------------
 615           * FUNCTION: Init_Kbd - Scanner Keyboard Initialization.
 616           * ------------------------------------------------------------------------- */
 617          void Unlock_Scan(void)
 618          {
 619   1              Int_Var.Scan_Lock = 0;
 620   1      }
 621          
 622          void CheckKSO1617Support(void)
 623          {
 624   1              ExtendScanPin = 0x00;
 625   1      
 626   1              if((KSO16CtrlReg&0xFB)==0x00)
 627   1              {
 628   2                      ExtendScanPin++;
 629   2              }
 630   1      
 631   1              if((KSO17CtrlReg&0xFB)==0x00)
 632   1              {
 633   2                      ExtendScanPin++;
 634   2              }
 635   1      
 636   1              if(ExtendScanPin!=0x00)
 637   1              {
 638   2                      ExtendMatrix = 1;
 639   2              }
 640   1              else
 641   1              {
 642   2                      ExtendMatrix = 0;
 643   2              }
 644   1      //msmart test
 645   1              GPCRC3 = ALT + PULL_UP ;
 646   1              GPCRC5 = ALT +PULL_UP;
 647   1      }
 648          
 649          /* ----------------------------------------------------------------------------
 650           * FUNCTION: Init_Kbd - Scanner Keyboard Initialization.
 651           * ------------------------------------------------------------------------- */
 652          void Init_Kbd(void)
 653          {
 654   1      //msmart test   CheckKSO1617Support();
 655   1      
 656   1          Scan_Init();
 657   1      
 658   1          Hook_Setup_Scanner_Pntr();
 659   1          Setup_Diode_Key();
 660   1      
 661   1          new_keyh.byte = 0;
 662   1          new_keyl.byte = 0;
 663   1      
 664   1          ClearExtendKeys();  // for extend keys
 665   1      
 666   1          Clear_Fn_Keys();
 667   1          Clear_Key();        /* Clear key matrix/buffer */
 668   1          Clear_Typematic();
 669   1      
 670   1          Enable_Any_Key_Irq();
 671   1      
 672   1          FN_Key_Break = 0x00;        // Clear FN_Key_Break
 673   1          FN_Key_Break_HS = 0x00;
 674   1          table_entry_bk = 0x00;
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 12  

 675   1      
 676   1          #if KB_FnStickKey
                  FnStickKey = 0;
                  #endif
 679   1      }
 680          
 681          /* ----------------------------------------------------------------------------
 682           * FUNCTION:   Setup_Diode_Key
 683           * ------------------------------------------------------------------------- */
 684          void Setup_Diode_Key(void)
 685          {
 686   1              if(1)
 687   1              {
 688   2              //if (Ext_Cb3_DISABLE_NKEY) { /* Simple matrix (NO diodes) */
 689   2              diode_key = 0x00;
 690   2          }
 691   1          else
 692   1              {                      /* N-key (diodes in keyboard) */
 693   2              diode_key = 0xFF;
 694   2          }
 695   1      }
 696          
 697          
 698          /* ----------------------------------------------------------------------------
 699           * FUNCTION: Clear_Key - Clear local keyboard buffer and related variables.
 700           * ------------------------------------------------------------------------- */
 701          void Clear_Key(void)
 702          {
 703   1          BYTE i;
 704   1          //WORD msk_strobe;
 705   1      
 706   1          for(i = 0; i < MAX_SCAN_LINES; i++) // Clear scan matrix.
 707   1          {
 708   2              bscan_matrix[i] = 0;
 709   2          }
 710   1      
 711   1          for(i = 0; i < KBF_SIZE; i++)               // Clear key buffer.
 712   1          {
 713   2              bKEY_BUFF[i] = 0;
 714   2          }
 715   1      
 716   1          scan.kbf_head = 0;
 717   1          scan.kbf_tail = 0;
 718   1          typematic.byte = 0;
 719   1          scan.saf_make = 0;
 720   1          scan.saf_break = 0;
 721   1          scan.saf_keys = 0;
 722   1          scan.scan_line = 0;
 723   1      }
 724          
 725          
 726          /* ----------------------------------------------------------------------------
 727           * FUNCTION: Clear_Typematic - Set default typematic delay and clear type-matic action.
 728           * ------------------------------------------------------------------------- */
 729          void Clear_Typematic(void)
 730          {
 731   1          typematic.byte = 0;
 732   1          bTMdelay = TM_DELAY;
 733   1          bTMrepeat = TM_REPEAT;
 734   1      }
 735          
 736          /* ----------------------------------------------------------------------------
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 13  

 737           * FUNCTION: Set_Typematic - Set the typematic rate.
 738           *
 739           * Input: typematic rate
 740           *        Bit[4:0] Typematic repeat interval
 741           *        Bit[6:5] Delay time
 742           * ------------------------------------------------------------------------- */
 743          //const BYTE code repeat_tbl[] =
 744          //{
 745          //     3,  4,  4,  5,  5,  6,  6,  7,  7,  8,  9, 10, 11, 12, 13, 14,
 746          //    15, 16, 18, 20, 22, 24, 25, 27, 30, 33, 37, 41, 44, 48, 52, 55
 747          //};
 748          //const BYTE code delay_tbl[] = {27, 55, 83, 111};
 749          
 750          const BYTE code repeat_tbl[] =
 751          {
 752              3,  4,  4,  5,  5,  5,  6,  6,  7,  7,  8, 9, 10, 11, 11, 12,
 753              13, 15, 16, 18, 20, 21, 23, 25, 27, 30, 33, 37, 40, 43, 47, 50
 754          };
 755          const BYTE code delay_tbl[] = {25, 50, 75, 100};
 756          
 757          void Set_Typematic(WORD type_rate)
 758          {
 759   1          Save_Typematic = type_rate;   /* Save for suspend/resume. */
 760   1      
 761   1          /* Bit 4 - 0 typematic repeat interval index. */
 762   1          bTMrepeat = repeat_tbl[type_rate & 0x1F];
 763   1      
 764   1          /* Bit 6 - 5 delay time index. */
 765   1          bTMdelay = delay_tbl[(type_rate >> 5) & 0x03];
 766   1      }
 767          
 768          
 769          /* ----------------------------------------------------------------------------
 770           * FUNCTION: Handle_Scan - Service the local keyboard in response to a key press.
 771           * ------------------------------------------------------------------------- */
 772          void service_scan(void)
 773          {
 774   1              BYTE scan_activity;
 775   1      
 776   1          if (Timer_A.fbit.TMR_SCAN == 0)
 777   1          {
 778   2              Timer_A.fbit.TMR_SCAN = 1;      // Activate scan timer.
 779   2          }
 780   1      
 781   1              if(ExtendMatrix)                                // extend keys
 782   1              {
 783   2                      scan_activity = scan_keys()|bScanExtendKeys();
 784   2              }
 785   1              else
 786   1              {
 787   2                      scan_activity = scan_keys();// Scan keyboard matrix one time.
 788   2              }
 789   1      
 790   1              if (scan_activity)                              // There is scan activity.
 791   1             {
 792   2                      if (SystemIsS3&&Read_LID_SW_IN()) //MARTINA025:add LID judge;
 793   2                      {
 794   3                              //if ( DSxPowState != SYSTEM_DSxOK )
 795   3                              //{
 796   3                                      if (KB_S3Dly > 10)
 797   3                                      {
 798   4                                      //      PWSeqStep = 1; //ANGELAG039: remove
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 14  

 799   4                                      //      PowSeqDelay = 1; //ANGELAG039: remove
 800   4                          RamDebug(0x30);         //T045A
 801   4                              //    SysPowState=SYSTEM_S3_S0; //ANGELAG039: remove
 802   4                                      PulseSBPowerButton(); //ANGELAG039: add 
 803   4                                      }
 804   3                                      KB_S3Dly++;
 805   3                              //}
 806   3                      }
 807   2              }
 808   1          else                                                        // No scan activity
 809   1          {
 810   2                      KB_S3Dly = 0;
 811   2              Timer_A.fbit.TMR_SCAN = 0;  // Disable the scan timer.
 812   2              F_Service_KEY = 0;              // Clear any pending service request.
 813   2              Enable_Any_Key_Irq();       // Enable Any Key interrupt.
 814   2              FN_Key_Break = 0x00;        // Clear FN_Key_Break
 815   2              FN_Key_Break_HS = 0x00;
 816   2              table_entry_bk = 0x00;
 817   2          }
 818   1      
 819   1          if (Timer_B.fbit.SEND_ENABLE == 0)  // 1 = Device send request (Request already set)
 820   1          {
 821   2                      if (Check_Scan_Transmission())  // Data available
 822   2                      {
 823   3                      Start_Scan_Transmission();      // Start new transmission
 824   3              }
 825   2          }
 826   1      }
 827          
 828          
 829          /*****************************************************************************/
 830          /********** SCANNER KEY BUFFER ROUTINES **************************************/
 831          /*****************************************************************************/
 832          
 833          /* ----------------------------------------------------------------------------
 834           * FUNCTION:   Get_Buffer
 835           *
 836           * Get data byte from keyboard buffer (if not empty) and update "scan.kbf_head"
 837           * with new index into keyboard buffer.
 838           *
 839           * Return: Data from buffer (WORD of all 1's if buffer is empty).
 840           * ------------------------------------------------------------------------- */
 841          //WORD Get_Buffer(void)
 842          BYTE Get_Buffer(void)
 843          {
 844   1          //WORD buffer_data;
 845   1          BYTE buffer_data;
 846   1      
 847   1          if (scan.kbf_head != scan.kbf_tail)
 848   1          {
 849   2              //buffer_data = (WORD) bKEY_BUFF[scan.kbf_head++];
 850   2                      buffer_data = bKEY_BUFF[scan.kbf_head++];
 851   2              if (scan.kbf_head >= KBF_SIZE)
 852   2                      {
 853   3                  scan.kbf_head = 0;
 854   3              }
 855   2          }
 856   1          else
 857   1          {   /* Buffer is empty. */
 858   2              buffer_data = 0xFF;
 859   2          }
 860   1          return (buffer_data);
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 15  

 861   1      }
 862          
 863          /* ----------------------------------------------------------------------------
 864           * FUNCTION:   Buffer_Mark - Mark local keyboard buffer tail.
 865           * ------------------------------------------------------------------------- */
 866          void Buffer_Mark(void)
 867          {
 868   1          scan.kbf_mark = scan.kbf_tail;   /* Copy scan.kbf_tail to scan.kbf_mark. */
 869   1      }
 870          
 871          /* ----------------------------------------------------------------------------
 872           * FUNCTION:   Buffer_Key
 873           *
 874           * Input:  Row/Column (0iii,oooo) to put in buffer.
 875           * Return: TRUE operation successful, FALSE unsuccessful.
 876           * ------------------------------------------------------------------------- */
 877          FLAG Buffer_Key(BYTE row_column)
 878          {
 879   1          FLAG ready = TRUE;  /* Ready for successful operation */
 880   1      
 881   1          bKEY_BUFF[scan.kbf_tail] = row_column;  /* Store Data to Buffer Tail */
 882   1          scan.kbf_tail++;                        /* Increment Buffer Tail (pointer) */
 883   1      
 884   1          if (scan.kbf_tail >= KBF_SIZE)
 885   1              {
 886   2              scan.kbf_tail = 0;  /* Wrap pointer if too large. */
 887   2          }
 888   1      
 889   1          /* Check Overflow */
 890   1          if (scan.kbf_tail == scan.kbf_head)
 891   1          {   /* Overflow */
 892   2              scan.kbf_tail = scan.kbf_mark;  /* Restore buffer marker. */
 893   2              bKEY_BUFF[scan.kbf_tail] = 0;   /* Set OverFlow Mark. */
 894   2              ready = FALSE;                  /* Overflow Indication !!! */
 895   2          }
 896   1      
 897   1          return (ready);
 898   1      }
 899          
 900          
 901          /* ----------------------------------------------------------------------------
 902           * FUNCTION:   Buffer_String
 903           *
 904           * Places a string in the local keyboard buffer (without a terminating NULL).
 905           * Call Buffer_Key to place data in key buffer.
 906           *
 907           * Input:  Pointer to null terminated string.
 908           * Return: 0x80 if buffer overflow error, else 0.
 909           * ------------------------------------------------------------------------- */
 910          BYTE Buffer_String(const BYTE *pntr)
 911          {
 912   1          register BYTE error = 0;
 913   1      
 914   1          while ((*pntr != 0) && (error == 0))
 915   1          {
 916   2              if (Buffer_Key(*pntr++) == 0) {
 917   3                  error = 0x80;   /* Indicate Overflow */
 918   3              }
 919   2          }
 920   1      
 921   1          return (error);
 922   1      }
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 16  

 923          
 924          //*****************************************************************
 925          // The functions of extend keys
 926          //*****************************************************************
 927          //-----------------------------------------------------------------
 928          // The function of Scaning extend keys
 929          //-----------------------------------------------------------------
 930          BYTE bScanExtendKeys(void)
 931          {
 932   1              ITempB06 = FALSE;
 933   1              extendscan.saf_break = 0;
 934   1              extendscan.saf_make= 0;
 935   1              extendscan.saf_keys= 0;
 936   1      
 937   1              if (etkeytypematic.byte)
 938   1              {
 939   2              CheckEtKeystm(etkeytypematic);  // Check typematic.
 940   2              }
 941   1      
 942   1              if (new_extendkey.byte)
 943   1              {                                                               // Yes, bounding.
 944   2              extendscan.saf_make = 1;
 945   2              DebounceExtendkey();
 946   2              ITempB06 = TRUE;
 947   2              }
 948   1      
 949   1              if(ITempB06 == FALSE)
 950   1              {
 951   2              for (ITempB01=0;ITempB01<ExtendScanPin;ITempB01++)
 952   2              {
 953   3                              SetExtendScanLines(ITempB01);
 954   3                              CapDelay();                                     //msmart
 955   3                              CapDelay();                                     //msmart
 956   3                              CapDelay();                                     //msmart
 957   3                              ITempB02 = KSI;
 958   3                              ITempB02 = (~ITempB02)^bscan_matrix[ITempB01+STANDARD_SCAN_LINES];
 959   3                  if (ITempB02 != 0)
 960   3                      {
 961   4                                      CheckExtendKeys(ITempB02,(ITempB01+STANDARD_SCAN_LINES));
 962   4                      }
 963   3      
 964   3                  if (bscan_matrix[ITempB01+STANDARD_SCAN_LINES])
 965   3                      {                                                               // Here, if current still active.
 966   4                      extendscan.saf_keys = 1;        // Set keys active bits. Check all key release.
 967   4                  }
 968   3              }
 969   2              }
 970   1      
 971   1              if (extendstatus.field.ghost == 1)
 972   1              {
 973   2              extendstatus.field.ghost = 0;   // Ghost flag is set.
 974   2              ITempB01 = extendstatus.byte & 7;
 975   2                      if (ITempB01 == 0)
 976   2              {
 977   3                      ITempB01 = Byte_Mask((BYTE)(new_extendkey.field.input));
 978   3                      ITempB01 = ITempB01 & diode_key;
 979   3                      }
 980   2              if (ITempB01 == 0)
 981   2              {
 982   3                      new_extendkey.byte = 0;         // Clear new key.
 983   3                      extendstatus.byte = 0;
 984   3              }
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 17  

 985   2              }
 986   1      
 987   1              return((BYTE) (extendscan.saf_make + extendscan.saf_break + extendscan.saf_keys));
 988   1      }
 989          
 990          //-----------------------------------------------------------------
 991          // The function of Setting extend scan lines
 992          //-----------------------------------------------------------------
 993          void SetExtendScanLines(BYTE scan_line)
 994          {
 995   1              if(scan_line<0x02)
 996   1              {
 997   2                      KSOL = 0xFF;
 998   2                      KSOH1 = 0xFF;
 999   2                      KSOH2 = ~(0x01<<scan_line);
1000   2                      Hook_SetGPIOScanPinH();
1001   2              }
1002   1              else
1003   1              {
1004   2                      KSOL = 0xFF;
1005   2                      KSOH1 = 0xFF;
1006   2                      KSOH2 = 0xFF;
1007   2                      Hook_SetGPIOScanPinL();
1008   2              }
1009   1              CapDelay();  // WY 2012.11.28
1010   1      }
1011          
1012          //-----------------------------------------------------------------
1013          // The function of Setting extend scan lines
1014          //-----------------------------------------------------------------
1015          void CheckExtendKeys(KSI_bit_num, scan_address)
1016          {
1017   1          BYTE flag;
1018   1          BYTE change_make_key;
1019   1      
1020   1              flag = FALSE;
1021   1              if (extendstatus.field.ghost == 1)
1022   1              {
1023   2              flag = TRUE;
1024   2              }
1025   1              else
1026   1              {                                                       // Find 0 -> 1 's.
1027   2                      change_make_key = KSI_bit_num & ~bscan_matrix[scan_address];
1028   2              if (change_make_key == 0)
1029   2                      {
1030   3                      flag = FALSE;
1031   3              }
1032   2              else if (find_paths(change_make_key, scan_address))
1033   2                      {
1034   3                      flag = TRUE;                            // TRUE if ghost keys.
1035   3              }
1036   2              }
1037   1      
1038   1              if (flag)
1039   1              {                                                               // Ghost exists.
1040   2              extendstatus.field.ghost = 1;   // Set ghost flag.
1041   2              KSI_bit_num &= bscan_matrix[scan_address] | diode_key;
1042   2              }
1043   1      
1044   1              ITempB03 = 0x00;
1045   1          while (KSI_bit_num != 0)
1046   1          {
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 18  

1047   2              if (KSI_bit_num & 0x01)
1048   2                      {
1049   3                      if (bscan_matrix[scan_address] & Byte_Mask(ITempB03))
1050   3                              {
1051   4                              if (extendscan.saf_break == 0)
1052   4                                      {
1053   5                              extendscan.saf_break = 1;
1054   5                                              ExtendKeyDebounce(ITempB03, scan_address, BREAK_EVENT);
1055   5                              }
1056   4                      }
1057   3                      else
1058   3                      {
1059   4                              if (extendscan.saf_make == 0)
1060   4                                      {
1061   5                              extendscan.saf_make = 1;
1062   5                                              ExtendKeyDebounce(ITempB03, scan_address, MAKE_EVENT);
1063   5                              }
1064   4                      }
1065   3              }
1066   2              ITempB03++;
1067   2              KSI_bit_num = KSI_bit_num >> 1; /* Shift bit out (and a zero bit in) to check next bit. */
1068   2          }
1069   1      }
1070          
1071          //-----------------------------------------------------------------
1072          // The function of extend keys debounce
1073          //-----------------------------------------------------------------
1074          void ExtendKeyDebounce(BYTE KSI_bit_num, BYTE scan_address, BYTE event)
1075          {
1076   1          new_extendkey.field.output = scan_address-STANDARD_SCAN_LINES;
1077   1          new_extendkey.field.input = KSI_bit_num;
1078   1          new_extendkey.field.debounce_status = 1;
1079   1          extendstatus.field.state = 0;  // Debounce has not counted out. */
1080   1          extendstatus.field.same = 0;   // Key activity indication. */
1081   1      
1082   1          if (event == MAKE_EVENT)
1083   1          {
1084   2              extendstatus.field.trans = 0;
1085   2              extendstatus.field.count = 1;//Ext_Cb2.field.Break_Count;
1086   2          }
1087   1          else
1088   1          {
1089   2              extendstatus.field.trans = 1;
1090   2              extendstatus.field.count = 1;//Ext_Cb2.field.Make_Count;
1091   2          }
1092   1      }
1093          
1094          
1095          void DebounceExtendkey(void)
1096          {
1097   1              SetExtendScanLines(new_extendkey.field.output);
1098   1              ITempB04 = Read_Scan_Lines();
1099   1              ITempB04 = ~ITempB04;
1100   1              ITempB05 = Byte_Mask((BYTE)(new_extendkey.field.input));
1101   1              ITempB05 = ITempB05 & ITempB04;
1102   1      
1103   1              if (ITempB05 != 0)
1104   1          {
1105   2              if (extendstatus.field.trans == 0)      // key make
1106   2                      {
1107   3                  extendstatus.field.same = 1;        // last key detected as a MAKE, same = 1.
1108   3              }
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 19  

1109   2              else
1110   2                      {
1111   3                  extendstatus.field.same = 0;    // last key detected as a BREAK, same = 0.
1112   3              }
1113   2          }
1114   1          else
1115   1          {
1116   2              if (extendstatus.field.trans == 0)
1117   2                      {
1118   3                  extendstatus.field.same = 0;    // last key detected as a MAKE, same = 0.
1119   3              }
1120   2              else
1121   2                      {
1122   3                  extendstatus.field.same = 1;    // last key detected as a BREAK, same = 1.
1123   3              }
1124   2          }
1125   1      
1126   1          if (extendstatus.field.state == 0)  // 1 means debounce counted out.
1127   1          {
1128   2              if (extendstatus.field.count != 0)
1129   2              {
1130   3                  extendstatus.field.count--;
1131   3              }
1132   2              else
1133   2              {
1134   3                  if (extendstatus.field.same == 0)
1135   3                  {
1136   4                      new_extendkey.byte = 0; // Debounce failed, so claer all data
1137   4                      extendstatus.byte = 0;
1138   4                  }
1139   3                  else
1140   3                  {
1141   4                      extendstatus.field.state = 1;
1142   4                  }
1143   3              }
1144   2          }
1145   1          else
1146   1          {
1147   2              if (extendstatus.field.same == 0)
1148   2              {
1149   3                  new_extendkey.byte = 0;     /* Debounce failed. */
1150   3                  extendstatus.byte = 0;
1151   3              }
1152   2              else
1153   2              {
1154   3                      CheckExtendKeyValid();
1155   3              }
1156   2          }
1157   1      }
1158          
1159          
1160          //-----------------------------------------------------------------
1161          // The function of checking extend key valid
1162          //-----------------------------------------------------------------
1163          void CheckExtendKeyValid(void)
1164          {
1165   1          ITempB02 = Byte_Mask((BYTE) (new_extendkey.field.input));
1166   1          ITempB01 = bscan_matrix[(new_extendkey.field.output + STANDARD_SCAN_LINES)];
1167   1          ITempB01 = ITempB01 ^ ITempB02;
1168   1          bscan_matrix[(new_extendkey.field.output + STANDARD_SCAN_LINES)] = ITempB01;
1169   1      
1170   1              ITempB03 = BREAK_EVENT;
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 20  

1171   1          if ((ITempB02 & ITempB01) != 0)
1172   1          {
1173   2              ITempB03 = MAKE_EVENT;
1174   2              etkeytypematic.byte = new_extendkey.byte;
1175   2              extendscan.TMscale = TM_SCALE;
1176   2              bTMcount = bTMdelay;
1177   2      
1178   2                      typematic.byte = 0x00;
1179   2          }
1180   1      
1181   1          Send_EtScan2(new_extendkey, ITempB03);
1182   1          new_extendkey.byte = 0;
1183   1          extendstatus.byte = 0;
1184   1      }
1185          
1186          //-----------------------------------------------------------------
1187          // The function of
1188          //-----------------------------------------------------------------
1189          void Send_EtScan2(union KEY key, BYTE event)
1190          {
1191   1              if(IS_MASK_SET(UtilityFlag,KBDebug))
1192   1              {
1193   2                      if(KeyScanACK==KU_ACK_Start)
1194   2                      {
1195   3                              if(event==MAKE_EVENT)
1196   3                              {
1197   4                                      KeyScanKSI = key.field.input;
1198   4                                      KeyScanKSO = key.field.output;
1199   4                                      KeyScanACK = KU_ACK_FullKeyboard;
1200   4                              }
1201   3                      }
1202   2              }
1203   1              else
1204   1              {
1205   2              ITempB02 = (key.field.input * 3) + key.field.output;
1206   2              #if SUPPORT_KB_RAM_TABLE
1207   2                      ITempB01 = *(Extendkey_RAM_Pntr + ITempB02);
1208   2                      #else
                              ITempB01 = *(Extendkey_Table_Pntr + ITempB02);
                              #endif
1211   2      
1212   2                      Et_Hook_keyboard(key.field.input, key.field.output);
1213   2              Send_Key(ITempB01, event);
1214   2              }
1215   1      }
1216          
1217          //-----------------------------------------------------------------
1218          // The function of clearing extend keys
1219          //-----------------------------------------------------------------
1220          void ClearExtendKeys(void)
1221          {
1222   1              new_extendkey.byte = 0;
1223   1              extendstatus.byte = 0;
1224   1              etkeytypematic.byte = 0;
1225   1      }
1226          
1227          //-----------------------------------------------------------------
1228          // The function of checking extend keys Typematic
1229          //-----------------------------------------------------------------
1230          void CheckEtKeystm(union KEY key)
1231          {
1232   1              ITempB02 = FALSE;
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 21  

1233   1          ITempB01 = Byte_Mask((BYTE) (key.field.input));
1234   1          ITempB01 = ITempB01 & bscan_matrix[key.field.output+STANDARD_SCAN_LINES];
1235   1      
1236   1          if (ITempB01 == 0)
1237   1          {
1238   2              etkeytypematic.byte = 0;
1239   2              ITempB02 = TRUE;
1240   2          }
1241   1      
1242   1          if (!ITempB02)
1243   1          {
1244   2              extendscan.TMscale--;
1245   2              if (extendscan.TMscale != 0)
1246   2                      {
1247   3                  ITempB02 = TRUE;
1248   3              }
1249   2          }
1250   1      
1251   1          if (!ITempB02)
1252   1          {
1253   2              extendscan.TMscale = TM_SCALE;
1254   2              bTMcount--;
1255   2              if (bTMcount != 0)
1256   2                      {
1257   3                  ITempB02 = TRUE;
1258   3              }
1259   2          }
1260   1      
1261   1          if (!ITempB02)
1262   1          {
1263   2              bTMcount = bTMrepeat;
1264   2              Send_EtScan2(key,REPEAT_EVENT);
1265   2          }
1266   1      }
1267          
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 22  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION Com00E3 (BEGIN)
0000         L?0228:
0000         L?0229:
0000 AF00        E     MOV     R7,new_keyh
0002         L?0230:
0002 EF                MOV     A,R7
0003         L?0231:
0003 5407              ANL     A,#07H
0005 FF                MOV     R7,A
0006 7401              MOV     A,#01H
0008 C8                XCH     A,R0
0009 EF                MOV     A,R7
000A C8                XCH     A,R0
000B 08                INC     R0
000C 22                RET     
000D         L?0232:
000D 7800        E     MOV     R0,#LOW ?Send_Scan2?BYTE
000F 7C00        E     MOV     R4,#HIGH ?Send_Scan2?BYTE
0011 7D01              MOV     R5,#01H
0013         L?0233:
0013 7E00              MOV     R6,#00H
0015 7F01              MOV     R7,#01H
0017 020000      E     LJMP    ?C?COPY
001A         L?0234:
001A EF                MOV     A,R7
001B C4                SWAP    A
001C 540F              ANL     A,#0FH
001E FE                MOV     R6,A
001F EF                MOV     A,R7
0020 540F              ANL     A,#0FH
0022 FF                MOV     R7,A
0023 EE                MOV     A,R6
0024 14                DEC     A
0025         L?0235:
0025 540F              ANL     A,#0FH
0027 C4                SWAP    A
0028 54F0              ANL     A,#0F0H
002A 4F                ORL     A,R7
002B 22                RET     
002C         L?0236:
002C         L?0237:
002C 900000      E     MOV     DPTR,#KSOL
002F 74FF              MOV     A,#0FFH
0031 F0                MOVX    @DPTR,A
0032 900000      E     MOV     DPTR,#KSOH1
0035 F0                MOVX    @DPTR,A
0036 22                RET     
0037         L?0238:
0037 540F              ANL     A,#0FH
0039 2400        E     ADD     A,#LOW bKEY_BUFF
003B         L?0239:
003B F582              MOV     DPL,A
003D E4                CLR     A
003E 3400        E     ADDC    A,#HIGH bKEY_BUFF
0040 F583              MOV     DPH,A
0042 22                RET     
0043         L?0240:
0043 E500        E     MOV     A,scan+02H
0045 54EF              ANL     A,#0EFH
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 23  

0047 F500        E     MOV     scan+02H,A
0049 54DF              ANL     A,#0DFH
004B F500        E     MOV     scan+02H,A
004D 54BF              ANL     A,#0BFH
004F F500        E     MOV     scan+02H,A
0051 22                RET     
0052         L?0241:
0052 AF00        E     MOV     R7,new_keyl
0054         L?0242:
0054 EF                MOV     A,R7
0055 13                RRC     A
0056 13                RRC     A
0057 13                RRC     A
0058 541F              ANL     A,#01FH
005A 22                RET     
005B         L?0243:
005B C4                SWAP    A
005C 5401              ANL     A,#01H
005E 2F                ADD     A,R7
005F FF                MOV     R7,A
0060 EE                MOV     A,R6
0061 C4                SWAP    A
0062 13                RRC     A
0063 13                RRC     A
0064 5401              ANL     A,#01H
0066 2F                ADD     A,R7
0067 FF                MOV     R7,A
0068 22                RET     
0069         L?0244:
0069 E4                CLR     A
006A 900000      E     MOV     DPTR,#FN_Key_Break
006D F0                MOVX    @DPTR,A
006E 900000      E     MOV     DPTR,#FN_Key_Break_HS
0071 F0                MOVX    @DPTR,A
0072 900000      E     MOV     DPTR,#table_entry_bk
0075 F0                MOVX    @DPTR,A
0076 22                RET     
0077         L?0245:
0077 A3                INC     DPTR
0078         L?0246:
0078 E0                MOVX    A,@DPTR
0079 FD                MOV     R5,A
007A 2400        E     ADD     A,#LOW bscan_matrix
007C F8                MOV     R0,A
007D E6                MOV     A,@R0
007E 22                RET     
007F         L?0247:
007F 2F                ADD     A,R7
0080 F8                MOV     R0,A
0081 E6                MOV     A,@R0
0082 FF                MOV     R7,A
0083 E500        E     MOV     A,ITempB02
0085 F4                CPL     A
0086 6F                XRL     A,R7
0087 F500        E     MOV     ITempB02,A
0089 E500        E     MOV     A,ITempB02
008B 22                RET     
008C         L?0248:
008C AF00        E     MOV     R7,new_keyh
008E EF                MOV     A,R7
008F         L?0249:
008F C4                SWAP    A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 24  

0090 540F              ANL     A,#0FH
0092 2400        E     ADD     A,#LOW bscan_matrix
0094 F8                MOV     R0,A
0095 22                RET     
0096         L?0250:
0096 E4                CLR     A
0097         L?0251:
0097 900000      E     MOV     DPTR,#KSOL
009A F0                MOVX    @DPTR,A
009B 900000      E     MOV     DPTR,#KSOH1
009E 22                RET     
009F         L?0252:
009F AF00        E     MOV     R7,new_extendkey
00A1 EF                MOV     A,R7
00A2         L?0253:
00A2 C4                SWAP    A
00A3 540F              ANL     A,#0FH
00A5 2400        E     ADD     A,#LOW bscan_matrix+010H
00A7 F8                MOV     R0,A
00A8 22                RET     
00A9         L?0254:
00A9 540F              ANL     A,#0FH
00AB C4                SWAP    A
00AC 54F0              ANL     A,#0F0H
00AE FE                MOV     R6,A
00AF ED                MOV     A,R5
00B0 540F              ANL     A,#0FH
00B2 4E                ORL     A,R6
00B3 22                RET     
00B4         L?0255:
00B4 120000      R     LCALL   CapDelay
00B7 900000      E     MOV     DPTR,#KSI
00BA E0                MOVX    A,@DPTR
00BB F500        E     MOV     ITempB02,A
00BD 22                RET     
00BE         L?0256:
00BE         L?0257:
00BE 7401              MOV     A,#01H
00C0 C8                XCH     A,R0
00C1 EF                MOV     A,R7
00C2 C8                XCH     A,R0
00C3 08                INC     R0
00C4 22                RET     
00C5         L?0258:
00C5 900000      E     MOV     DPTR,#bTMdelay
00C8 E0                MOVX    A,@DPTR
00C9 900000      E     MOV     DPTR,#bTMcount
00CC F0                MOVX    @DPTR,A
00CD E4                CLR     A
00CE 22                RET     
00CF         L?0259:
00CF         L?0260:
00CF AE00        E     MOV     R6,scan
00D1 EE                MOV     A,R6
00D2 C4                SWAP    A
00D3 540F              ANL     A,#0FH
00D5 22                RET     
00D6         L?0261:
00D6         L?0262:
00D6 900000      R     MOV     DPTR,#key
00D9 E0                MOVX    A,@DPTR
00DA 5407              ANL     A,#07H
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 25  

00DC 22                RET     
             ; FUNCTION Com00E3 (END)

             ; FUNCTION CapDelay (BEGIN)
                                           ; SOURCE LINE # 15
                                           ; SOURCE LINE # 16
                                           ; SOURCE LINE # 17
0000 E4                CLR     A
0001 900000      E     MOV     DPTR,#WNCKR
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 19
0005 22                RET     
             ; FUNCTION CapDelay (END)

             ; FUNCTION scan_keys (BEGIN)
                                           ; SOURCE LINE # 29
                                           ; SOURCE LINE # 30
                                           ; SOURCE LINE # 32
0000 E4                CLR     A
0001 900000      R     MOV     DPTR,#result
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 34
                                           ; SOURCE LINE # 35
                                           ; SOURCE LINE # 36
0005 120000      R     LCALL   L?0240
                                           ; SOURCE LINE # 38
0008 E500        E     MOV     A,typematic
000A 6012              JZ      ?C0002
                                           ; SOURCE LINE # 39
                                           ; SOURCE LINE # 40
000C 7800        R     MOV     R0,#LOW ?check_tm?BYTE
000E 7C00        R     MOV     R4,#HIGH ?check_tm?BYTE
0010 7D01              MOV     R5,#01H
0012 7B00              MOV     R3,#00H
0014 7A00        E     MOV     R2,#HIGH typematic
0016 7900        E     MOV     R1,#LOW typematic
0018 120000      R     LCALL   L?0233
001B 120000      R     LCALL   check_tm
                                           ; SOURCE LINE # 41
001E         ?C0002:
                                           ; SOURCE LINE # 43
001E E500        E     MOV     A,new_keyh
0020 600F              JZ      ?C0003
                                           ; SOURCE LINE # 44
                                           ; SOURCE LINE # 45
0022 E500        E     MOV     A,scan+02H
0024 4410              ORL     A,#010H
0026 F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 46
0028 120000      R     LCALL   debounce_key
                                           ; SOURCE LINE # 47
002B 900000      R     MOV     DPTR,#result
002E 7401              MOV     A,#01H
0030 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 48
0031         ?C0003:
                                           ; SOURCE LINE # 50
0031 900000      R     MOV     DPTR,#result
0034 E0                MOVX    A,@DPTR
0035 7069              JNZ     ?C0004
                                           ; SOURCE LINE # 51
                                           ; SOURCE LINE # 52
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 26  

0037 F500        E     MOV     ITempB03,A
0039         ?C0005:
                                           ; SOURCE LINE # 53
                                           ; SOURCE LINE # 54
0039 AF00        E     MOV     R7,ITempB03
003B 120000      R     LCALL   _Write_Strobe
                                           ; SOURCE LINE # 55
                                           ; SOURCE LINE # 56
003E 120000      R     LCALL   L?0255
                                           ; SOURCE LINE # 57
0041 AF00        E     MOV     R7,ITempB03
0043 7400        E     MOV     A,#LOW bscan_matrix
                                           ; SOURCE LINE # 58
0045 120000      R     LCALL   L?0247
0048 6007              JZ      ?C0008
                                           ; SOURCE LINE # 59
                                           ; SOURCE LINE # 60
004A AD00        E     MOV     R5,ITempB03
004C AF00        E     MOV     R7,ITempB02
004E 120000      R     LCALL   _check_scan
                                           ; SOURCE LINE # 61
0051         ?C0008:
                                           ; SOURCE LINE # 63
0051 AF00        E     MOV     R7,ITempB03
0053 7400        E     MOV     A,#LOW bscan_matrix
0055 2F                ADD     A,R7
0056 F8                MOV     R0,A
0057 E6                MOV     A,@R0
0058 6006              JZ      ?C0009
                                           ; SOURCE LINE # 64
                                           ; SOURCE LINE # 65
005A E500        E     MOV     A,scan+02H
005C 4440              ORL     A,#040H
005E F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 66
0060         ?C0009:
                                           ; SOURCE LINE # 67
                                           ; SOURCE LINE # 68
0060 120000      R     LCALL   L?0236
                                           ; SOURCE LINE # 69
0063 900000      E     MOV     DPTR,#KSOH2
0066 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 70
0067 0500        E     INC     ITempB03
0069 E500        E     MOV     A,ITempB03
006B C3                CLR     C
006C 9410              SUBB    A,#010H
006E 40C9              JC      ?C0005
0070         ?C0006:
                                           ; SOURCE LINE # 72
0070 120000      R     LCALL   L?0241
0073 30E02A            JNB     ACC.0,?C0004
                                           ; SOURCE LINE # 73
                                           ; SOURCE LINE # 74
0076 AF00        E     MOV     R7,new_keyl
0078 EF                MOV     A,R7
0079 54F7              ANL     A,#0F7H
007B F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 75
007D E500        E     MOV     A,new_keyl
007F 5407              ANL     A,#07H
0081 F500        E     MOV     ITempB01,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 27  

                                           ; SOURCE LINE # 76
0083 E500        E     MOV     A,ITempB01
0085 7011              JNZ     ?C0011
                                           ; SOURCE LINE # 77
                                           ; SOURCE LINE # 78
0087 120000      R     LCALL   L?0228
008A 8002              SJMP    ?C0189
008C         ?C0188:
008C C3                CLR     C
008D 33                RLC     A
008E         ?C0189:
008E D8FC              DJNZ    R0,?C0188
0090 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 79
0092 900000      E     MOV     DPTR,#diode_key
0095 E0                MOVX    A,@DPTR
0096 5200        E     ANL     ITempB01,A
                                           ; SOURCE LINE # 80
0098         ?C0011:
                                           ; SOURCE LINE # 82
0098 E500        E     MOV     A,ITempB01
009A 7004              JNZ     ?C0004
                                           ; SOURCE LINE # 83
                                           ; SOURCE LINE # 84
009C F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 85
009E F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 86
                                           ; SOURCE LINE # 87
                                           ; SOURCE LINE # 88
00A0         ?C0004:
                                           ; SOURCE LINE # 90
00A0 AF00        E     MOV     R7,scan+02H
00A2 EF                MOV     A,R7
00A3 C4                SWAP    A
00A4 13                RRC     A
00A5 5401              ANL     A,#01H
00A7 FF                MOV     R7,A
00A8 AE00        E     MOV     R6,scan+02H
00AA EE                MOV     A,R6
00AB AE00        E     MOV     R6,scan+02H
00AD 120000      R     LCALL   L?0243
                                           ; SOURCE LINE # 91
00B0         ?C0013:
00B0 22                RET     
             ; FUNCTION scan_keys (END)

             ; FUNCTION _Write_Strobe (BEGIN)
                                           ; SOURCE LINE # 109
;---- Variable 'scan_line_num' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 110
                                           ; SOURCE LINE # 111
0000 EF                MOV     A,R7
0001 C3                CLR     C
0002 9408              SUBB    A,#08H
0004 5012              JNC     ?C0014
                                           ; SOURCE LINE # 112
                                           ; SOURCE LINE # 113
0006 120000      R     LCALL   L?0256
0009 8002              SJMP    ?C0191
000B         ?C0190:
000B C3                CLR     C
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 28  

000C 33                RLC     A
000D         ?C0191:
000D D8FC              DJNZ    R0,?C0190
000F F4                CPL     A
                                           ; SOURCE LINE # 114
0010 120000      R     LCALL   L?0251
0013 74FF              MOV     A,#0FFH
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 115
0016 8018              SJMP    ?C0015
0018         ?C0014:
                                           ; SOURCE LINE # 117
                                           ; SOURCE LINE # 118
0018 900000      E     MOV     DPTR,#KSOL
001B 74FF              MOV     A,#0FFH
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 119
001E EF                MOV     A,R7
001F 24F8              ADD     A,#0F8H
0021 FF                MOV     R7,A
0022 120000      R     LCALL   L?0256
0025 8002              SJMP    ?C0193
0027         ?C0192:
0027 C3                CLR     C
0028 33                RLC     A
0029         ?C0193:
0029 D8FC              DJNZ    R0,?C0192
002B F4                CPL     A
002C 900000      E     MOV     DPTR,#KSOH1
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 120
0030         ?C0015:
                                           ; SOURCE LINE # 122
0030 300009      E     JNB     ExtendMatrix,?C0017
                                           ; SOURCE LINE # 123
                                           ; SOURCE LINE # 124
0033 900000      E     MOV     DPTR,#KSOH2
0036 74FF              MOV     A,#0FFH
0038 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 125
0039 120000      E     LCALL   Hook_SetGPIOScanPinH
                                           ; SOURCE LINE # 126
                                           ; SOURCE LINE # 127
003C         ?C0017:
003C 22                RET     
             ; FUNCTION _Write_Strobe (END)

             ; FUNCTION _check_scan (BEGIN)
                                           ; SOURCE LINE # 143
0000 900000      R     MOV     DPTR,#changes
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 ED                MOV     A,R5
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 144
                                           ; SOURCE LINE # 149
0008 E4                CLR     A
0009 A3                INC     DPTR
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 150
000B 120000      R     LCALL   L?0241
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 29  

000E 30E002            JNB     ACC.0,?C0018
                                           ; SOURCE LINE # 151
                                           ; SOURCE LINE # 152
                                           ; SOURCE LINE # 153
0011 801F              SJMP    ?C0217
0013         ?C0018:
                                           ; SOURCE LINE # 155
                                           ; SOURCE LINE # 156
0013 900000      R     MOV     DPTR,#scan_address
0016 120000      R     LCALL   L?0246
0019 F4                CPL     A
001A FF                MOV     R7,A
001B 900000      R     MOV     DPTR,#changes
001E E0                MOVX    A,@DPTR
001F 5F                ANL     A,R7
0020 FF                MOV     R7,A
;---- Variable 'change_make_key' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 157
0021 7006              JNZ     ?C0020
                                           ; SOURCE LINE # 158
                                           ; SOURCE LINE # 159
0023 900000      R     MOV     DPTR,#flag
0026 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 160
0027 800C              SJMP    ?C0019
0029         ?C0020:
                                           ; SOURCE LINE # 161
0029 120000      R     LCALL   _find_paths
002C EF                MOV     A,R7
002D 6006              JZ      ?C0019
                                           ; SOURCE LINE # 162
                                           ; SOURCE LINE # 163
002F 900000      R     MOV     DPTR,#flag
0032         ?C0217:
0032 7401              MOV     A,#01H
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 164
                                           ; SOURCE LINE # 165
0035         ?C0019:
                                           ; SOURCE LINE # 167
0035 900000      R     MOV     DPTR,#flag
0038 E0                MOVX    A,@DPTR
0039 601F              JZ      ?C0023
                                           ; SOURCE LINE # 168
                                           ; SOURCE LINE # 169
003B AF00        E     MOV     R7,new_keyl
003D EF                MOV     A,R7
003E 4408              ORL     A,#08H
0040 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 171
0042 900000      R     MOV     DPTR,#changes
0045 E0                MOVX    A,@DPTR
0046 FF                MOV     R7,A
0047 A3                INC     DPTR
0048 E0                MOVX    A,@DPTR
0049 2400        E     ADD     A,#LOW bscan_matrix
004B F8                MOV     R0,A
004C E6                MOV     A,@R0
004D FE                MOV     R6,A
004E 900000      E     MOV     DPTR,#diode_key
0051 E0                MOVX    A,@DPTR
0052 4E                ORL     A,R6
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 30  

0053 FE                MOV     R6,A
0054 EF                MOV     A,R7
0055 5E                ANL     A,R6
0056 900000      R     MOV     DPTR,#changes
0059 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 172
005A         ?C0023:
                                           ; SOURCE LINE # 174
005A E4                CLR     A
005B 900000      R     MOV     DPTR,#bit_num
005E F0                MOVX    @DPTR,A
005F         ?C0024:
                                           ; SOURCE LINE # 175
005F 900000      R     MOV     DPTR,#changes
0062 E0                MOVX    A,@DPTR
0063 601F              JZ      ?C0027
                                           ; SOURCE LINE # 176
                                           ; SOURCE LINE # 177
0065 30E00D            JNB     ACC.0,?C0026
                                           ; SOURCE LINE # 178
                                           ; SOURCE LINE # 179
0068 900000      R     MOV     DPTR,#bit_num
006B E0                MOVX    A,@DPTR
006C FF                MOV     R7,A
006D 900000      R     MOV     DPTR,#scan_address
0070 E0                MOVX    A,@DPTR
0071 FD                MOV     R5,A
0072 120000      R     LCALL   _cscfnd
                                           ; SOURCE LINE # 180
0075         ?C0026:
                                           ; SOURCE LINE # 181
0075 900000      R     MOV     DPTR,#bit_num
0078 E0                MOVX    A,@DPTR
0079 04                INC     A
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 182
007B 900000      R     MOV     DPTR,#changes
007E E0                MOVX    A,@DPTR
007F C3                CLR     C
0080 13                RRC     A
0081 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 183
0082 80DB              SJMP    ?C0024
                                           ; SOURCE LINE # 184
0084         ?C0027:
0084 22                RET     
             ; FUNCTION _check_scan (END)

             ; FUNCTION _cscfnd (BEGIN)
                                           ; SOURCE LINE # 192
0000 900000      R     MOV     DPTR,#bit_num
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 ED                MOV     A,R5
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 193
                                           ; SOURCE LINE # 194
0008 120000      R     LCALL   L?0246
000B FB                MOV     R3,A
000C 7A00              MOV     R2,#00H
000E 900000      R     MOV     DPTR,#bit_num
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 31  

0011 E0                MOVX    A,@DPTR
0012 FC                MOV     R4,A
0013 7401              MOV     A,#01H
0015 7E00              MOV     R6,#00H
0017 C8                XCH     A,R0
0018 EC                MOV     A,R4
0019 C8                XCH     A,R0
001A 08                INC     R0
001B 8005              SJMP    ?C0195
001D         ?C0194:
001D C3                CLR     C
001E 33                RLC     A
001F CE                XCH     A,R6
0020 33                RLC     A
0021 CE                XCH     A,R6
0022         ?C0195:
0022 D8F9              DJNZ    R0,?C0194
0024 FF                MOV     R7,A
0025 EE                MOV     A,R6
0026 5A                ANL     A,R2
0027 FE                MOV     R6,A
0028 EF                MOV     A,R7
0029 5B                ANL     A,R3
002A 4E                ORL     A,R6
002B 6016              JZ      ?C0028
                                           ; SOURCE LINE # 195
                                           ; SOURCE LINE # 196
002D AF00        E     MOV     R7,scan+02H
002F EF                MOV     A,R7
0030 C4                SWAP    A
0031 13                RRC     A
0032 5407              ANL     A,#07H
0034 20E027            JB      ACC.0,?C0032
                                           ; SOURCE LINE # 197
                                           ; SOURCE LINE # 198
0037 EF                MOV     A,R7
0038 4420              ORL     A,#020H
003A F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 199
003C CF                XCH     A,R7
003D EC                MOV     A,R4
003E CF                XCH     A,R7
003F 7B01              MOV     R3,#01H
                                           ; SOURCE LINE # 200
                                           ; SOURCE LINE # 201
0041 8018              SJMP    ?C0218
0043         ?C0028:
                                           ; SOURCE LINE # 203
                                           ; SOURCE LINE # 204
0043 AF00        E     MOV     R7,scan+02H
0045 EF                MOV     A,R7
0046 C4                SWAP    A
0047 540F              ANL     A,#0FH
0049 20E012            JB      ACC.0,?C0032
                                           ; SOURCE LINE # 205
                                           ; SOURCE LINE # 206
004C EF                MOV     A,R7
004D 4410              ORL     A,#010H
004F F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 207
0051 900000      R     MOV     DPTR,#bit_num
0054 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 32  

0055 FF                MOV     R7,A
0056 A3                INC     DPTR
0057 E0                MOVX    A,@DPTR
0058 FD                MOV     R5,A
0059 E4                CLR     A
005A FB                MOV     R3,A
005B         ?C0218:
005B 120000      R     LCALL   _setup_debounce
                                           ; SOURCE LINE # 208
                                           ; SOURCE LINE # 209
                                           ; SOURCE LINE # 210
005E         ?C0032:
005E 22                RET     
             ; FUNCTION _cscfnd (END)

             ; FUNCTION _setup_debounce (BEGIN)
                                           ; SOURCE LINE # 220
;---- Variable 'bit_num' assigned to Register 'R7' ----
;---- Variable 'event' assigned to Register 'R3' ----
;---- Variable 'scan_address' assigned to Register 'R5' ----
                                           ; SOURCE LINE # 221
                                           ; SOURCE LINE # 222
0000 ED                MOV     A,R5
0001 AD00        E     MOV     R5,new_keyh
0003 120000      R     LCALL   L?0254
0006 F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 223
0008 EF                MOV     A,R7
0009 5407              ANL     A,#07H
000B FF                MOV     R7,A
000C AE00        E     MOV     R6,new_keyh
000E EE                MOV     A,R6
000F 54F8              ANL     A,#0F8H
0011 4F                ORL     A,R7
0012 F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 224
0014 AF00        E     MOV     R7,new_keyh
0016 EF                MOV     A,R7
0017 4408              ORL     A,#08H
0019 F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 225
001B AF00        E     MOV     R7,new_keyl
001D EF                MOV     A,R7
001E 54FE              ANL     A,#0FEH
0020 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 226
0022 AF00        E     MOV     R7,new_keyl
0024 EF                MOV     A,R7
0025 54EF              ANL     A,#0EFH
0027 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 228
0029 EB                MOV     A,R3
002A AF00        E     MOV     R7,new_keyl
002C 700F              JNZ     ?C0033
                                           ; SOURCE LINE # 229
                                           ; SOURCE LINE # 230
002E EF                MOV     A,R7
002F 54FD              ANL     A,#0FDH
0031 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 231
0033 7800        E     MOV     R0,#LOW Ext_Cb2
0035 E6                MOV     A,@R0
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 33  

0036 540E              ANL     A,#0EH
0038 C4                SWAP    A
0039 54F0              ANL     A,#0F0H
                                           ; SOURCE LINE # 232
003B 800A              SJMP    ?C0219
003D         ?C0033:
                                           ; SOURCE LINE # 234
                                           ; SOURCE LINE # 235
003D EF                MOV     A,R7
003E 4402              ORL     A,#02H
0040 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 236
0042 7800        E     MOV     R0,#LOW Ext_Cb2
0044 E6                MOV     A,@R0
0045 54E0              ANL     A,#0E0H
0047         ?C0219:
0047 FF                MOV     R7,A
0048 AE00        E     MOV     R6,new_keyl
004A EE                MOV     A,R6
004B 541F              ANL     A,#01FH
004D 4F                ORL     A,R7
004E F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 237
                                           ; SOURCE LINE # 238
0050         ?C0035:
0050 22                RET     
             ; FUNCTION _setup_debounce (END)

             ; FUNCTION _find_paths (BEGIN)
                                           ; SOURCE LINE # 248
;---- Variable 'temp' assigned to Register 'R6' ----
;---- Variable 'paths' assigned to Register 'R4' ----
;---- Variable 'bits' assigned to Register 'R1' ----
;---- Variable 'scan_address' assigned to Register 'R5' ----
;---- Variable 'change_make_key' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 249
                                           ; SOURCE LINE # 258
0000 E4                CLR     A
0001 900000      R     MOV     DPTR,#done
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 259
0005 900000      R     MOV     DPTR,#paths_found
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 260
0009 900000      R     MOV     DPTR,#first_address
000C ED                MOV     A,R5
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 262
000E 900000      E     MOV     DPTR,#diode_key
0011 E0                MOVX    A,@DPTR
0012 F4                CPL     A
0013 5F                ANL     A,R7
0014 FF                MOV     R7,A
                                           ; SOURCE LINE # 265
0015 7005              JNZ     ?C0036
                                           ; SOURCE LINE # 266
                                           ; SOURCE LINE # 267
0017 900000      R     MOV     DPTR,#done
001A 04                INC     A
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 268
001C         ?C0036:
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 34  

                                           ; SOURCE LINE # 270
001C 900000      R     MOV     DPTR,#done
001F E0                MOVX    A,@DPTR
0020 7015              JNZ     ?C0039
                                           ; SOURCE LINE # 271
                                           ; SOURCE LINE # 272
0022 7400        E     MOV     A,#LOW bscan_matrix
0024 2D                ADD     A,R5
0025 F8                MOV     R0,A
0026 E6                MOV     A,@R0
0027 4F                ORL     A,R7
0028 FC                MOV     R4,A
                                           ; SOURCE LINE # 273
0029 900000      E     MOV     DPTR,#diode_key
002C E0                MOVX    A,@DPTR
002D F4                CPL     A
002E 5C                ANL     A,R4
002F FC                MOV     R4,A
                                           ; SOURCE LINE # 275
0030 7005              JNZ     ?C0039
                                           ; SOURCE LINE # 276
                                           ; SOURCE LINE # 277
0032 900000      R     MOV     DPTR,#done
0035 04                INC     A
0036 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 278
                                           ; SOURCE LINE # 279
0037         ?C0039:
                                           ; SOURCE LINE # 281
0037 900000      R     MOV     DPTR,#done
003A E0                MOVX    A,@DPTR
003B 705E              JNZ     ?C0040
                                           ; SOURCE LINE # 282
                                           ; SOURCE LINE # 283
003D 0D                INC     R5
                                           ; SOURCE LINE # 285
003E ED                MOV     A,R5
003F C3                CLR     C
0040 9413              SUBB    A,#013H
0042 4002              JC      ?C0041
                                           ; SOURCE LINE # 287
                                           ; SOURCE LINE # 288
0044 E4                CLR     A
0045 FD                MOV     R5,A
                                           ; SOURCE LINE # 289
0046         ?C0041:
                                           ; SOURCE LINE # 291
0046 900000      R     MOV     DPTR,#first_address
0049 E0                MOVX    A,@DPTR
004A 6D                XRL     A,R5
004B 7005              JNZ     ?C0042
                                           ; SOURCE LINE # 292
                                           ; SOURCE LINE # 293
004D 900000      R     MOV     DPTR,#done
0050 04                INC     A
0051 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 294
0052         ?C0042:
                                           ; SOURCE LINE # 296
0052 900000      R     MOV     DPTR,#done
0055 E0                MOVX    A,@DPTR
0056 70DF              JNZ     ?C0039
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 35  

                                           ; SOURCE LINE # 297
                                           ; SOURCE LINE # 298
0058 7400        E     MOV     A,#LOW bscan_matrix
005A 2D                ADD     A,R5
005B F8                MOV     R0,A
005C E6                MOV     A,@R0
005D FE                MOV     R6,A
                                           ; SOURCE LINE # 299
005E 900000      E     MOV     DPTR,#diode_key
0061 E0                MOVX    A,@DPTR
0062 F4                CPL     A
0063 5E                ANL     A,R6
0064 FE                MOV     R6,A
                                           ; SOURCE LINE # 301
0065 6002              JZ      ?C0044
                                           ; SOURCE LINE # 302
                                           ; SOURCE LINE # 303
0067 5C                ANL     A,R4
0068 FE                MOV     R6,A
                                           ; SOURCE LINE # 304
0069         ?C0044:
                                           ; SOURCE LINE # 306
0069 EE                MOV     A,R6
006A 60CB              JZ      ?C0039
                                           ; SOURCE LINE # 307
                                           ; SOURCE LINE # 308
006C 6F                XRL     A,R7
006D 6008              JZ      ?C0046
                                           ; SOURCE LINE # 309
                                           ; SOURCE LINE # 310
006F 900000      R     MOV     DPTR,#paths_found
0072 7401              MOV     A,#01H
0074 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 311
0075 A3                INC     DPTR
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 312
0077         ?C0046:
                                           ; SOURCE LINE # 314
0077 900000      R     MOV     DPTR,#done
007A E0                MOVX    A,@DPTR
007B 70BA              JNZ     ?C0039
                                           ; SOURCE LINE # 315
                                           ; SOURCE LINE # 320
007D C9                XCH     A,R1
007E EC                MOV     A,R4
007F C9                XCH     A,R1
                                           ; SOURCE LINE # 321
0080 FE                MOV     R6,A
0081         ?C0050:
                                           ; SOURCE LINE # 324
                                           ; SOURCE LINE # 325
0081 E9                MOV     A,R1
0082 30E002            JNB     ACC.0,?C0051
                                           ; SOURCE LINE # 326
                                           ; SOURCE LINE # 327
0085 7E01              MOV     R6,#01H
                                           ; SOURCE LINE # 328
0087         ?C0051:
                                           ; SOURCE LINE # 331
0087 E9                MOV     A,R1
0088 C3                CLR     C
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 36  

0089 13                RRC     A
008A F9                MOV     R1,A
                                           ; SOURCE LINE # 332
008B EE                MOV     A,R6
008C 60F3              JZ      ?C0050
                                           ; SOURCE LINE # 334
008E E9                MOV     A,R1
008F 60A6              JZ      ?C0039
                                           ; SOURCE LINE # 335
                                           ; SOURCE LINE # 336
0091 900000      R     MOV     DPTR,#paths_found
0094 7401              MOV     A,#01H
0096 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 337
0097 A3                INC     DPTR
0098 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 338
                                           ; SOURCE LINE # 339
                                           ; SOURCE LINE # 340
                                           ; SOURCE LINE # 341
                                           ; SOURCE LINE # 342
0099 809C              SJMP    ?C0039
009B         ?C0040:
                                           ; SOURCE LINE # 344
009B 900000      R     MOV     DPTR,#paths_found
009E E0                MOVX    A,@DPTR
009F FF                MOV     R7,A
                                           ; SOURCE LINE # 345
00A0         ?C0053:
00A0 22                RET     
             ; FUNCTION _find_paths (END)

             ; FUNCTION debounce_key (BEGIN)
                                           ; SOURCE LINE # 350
                                           ; SOURCE LINE # 351
                                           ; SOURCE LINE # 352
0000 AF00        E     MOV     R7,new_keyh
0002 EF                MOV     A,R7
0003 54F0              ANL     A,#0F0H
0005 C4                SWAP    A
0006 540F              ANL     A,#0FH
0008 FF                MOV     R7,A
0009 E500        E     MOV     A,scan+02H
000B 54F0              ANL     A,#0F0H
000D 4F                ORL     A,R7
000E F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 353
0010 540F              ANL     A,#0FH
0012 FF                MOV     R7,A
0013 120000      R     LCALL   _Write_Strobe
                                           ; SOURCE LINE # 354
0016 120000      R     LCALL   CapDelay
                                           ; SOURCE LINE # 355
0019 120000      R     LCALL   Read_Scan_Lines
001C 8F00        E     MOV     ITempB01,R7
                                           ; SOURCE LINE # 356
001E 6300FF      E     XRL     ITempB01,#0FFH
                                           ; SOURCE LINE # 358
0021 120000      R     LCALL   L?0228
0024 8002              SJMP    ?C0197
0026         ?C0196:
0026 C3                CLR     C
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 37  

0027 33                RLC     A
0028         ?C0197:
0028 D8FC              DJNZ    R0,?C0196
002A F500        E     MOV     ITempB02,A
                                           ; SOURCE LINE # 359
002C E500        E     MOV     A,ITempB01
002E 5200        E     ANL     ITempB02,A
                                           ; SOURCE LINE # 361
0030 E500        E     MOV     A,ITempB02
0032 600C              JZ      ?C0054
                                           ; SOURCE LINE # 362
                                           ; SOURCE LINE # 363
0034 AF00        E     MOV     R7,new_keyl
0036 EF                MOV     A,R7
0037 C3                CLR     C
0038 13                RRC     A
0039 AF00        E     MOV     R7,new_keyl
003B 20E00C            JB      ACC.0,?C0221
                                           ; SOURCE LINE # 364
                                           ; SOURCE LINE # 365
                                           ; SOURCE LINE # 366
003E 8011              SJMP    ?C0220
0040         ?C0054:
                                           ; SOURCE LINE # 373
                                           ; SOURCE LINE # 374
0040 AF00        E     MOV     R7,new_keyl
0042 EF                MOV     A,R7
0043 C3                CLR     C
0044 13                RRC     A
0045 AF00        E     MOV     R7,new_keyl
0047 20E007            JB      ACC.0,?C0058
                                           ; SOURCE LINE # 375
                                           ; SOURCE LINE # 376
004A         ?C0221:
004A EF                MOV     A,R7
004B 54EF              ANL     A,#0EFH
004D F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 377
004F 8005              SJMP    ?C0057
0051         ?C0058:
                                           ; SOURCE LINE # 379
                                           ; SOURCE LINE # 380
0051         ?C0220:
0051 EF                MOV     A,R7
0052 4410              ORL     A,#010H
0054 F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 381
                                           ; SOURCE LINE # 382
0056         ?C0057:
                                           ; SOURCE LINE # 405
                                           ; SOURCE LINE # 406
0056 AF00        E     MOV     R7,new_keyl
0058 EF                MOV     A,R7
0059 C4                SWAP    A
005A 540F              ANL     A,#0FH
005C 20E006            JB      ACC.0,?C0060
                                           ; SOURCE LINE # 407
                                           ; SOURCE LINE # 408
005F E4                CLR     A
0060 F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 409
0062 F500        E     MOV     new_keyl,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 38  

                                           ; SOURCE LINE # 410
0064 22                RET     
0065         ?C0060:
                                           ; SOURCE LINE # 412
                                           ; SOURCE LINE # 413
0065 120000      R     LCALL   change_valid
                                           ; SOURCE LINE # 414
                                           ; SOURCE LINE # 415
                                           ; SOURCE LINE # 416
0068         ?C0062:
0068 22                RET     
             ; FUNCTION debounce_key (END)

             ; FUNCTION Read_Scan_Lines (BEGIN)
                                           ; SOURCE LINE # 426
                                           ; SOURCE LINE # 427
                                           ; SOURCE LINE # 428
0000 900000      E     MOV     DPTR,#KSI
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
                                           ; SOURCE LINE # 429
0005         ?C0063:
0005 22                RET     
             ; FUNCTION Read_Scan_Lines (END)

             ; FUNCTION change_valid (BEGIN)
                                           ; SOURCE LINE # 434
                                           ; SOURCE LINE # 435
                                           ; SOURCE LINE # 436
0000 120000      R     LCALL   L?0229
0003 8002              SJMP    ?C0199
0005         ?C0198:
0005 C3                CLR     C
0006 33                RLC     A
0007         ?C0199:
0007 D8FC              DJNZ    R0,?C0198
0009 F500        E     MOV     ITempB04,A
                                           ; SOURCE LINE # 437
000B 120000      R     LCALL   L?0248
000E E6                MOV     A,@R0
000F F500        E     MOV     ITempB03,A
                                           ; SOURCE LINE # 438
0011 E500        E     MOV     A,ITempB04
0013 6200        E     XRL     ITempB03,A
                                           ; SOURCE LINE # 439
0015 120000      R     LCALL   L?0248
0018 A600        E     MOV     @R0,ITempB03
                                           ; SOURCE LINE # 441
001A 750001      E     MOV     ITempB05,#01H
                                           ; SOURCE LINE # 442
001D E500        E     MOV     A,ITempB04
001F 5500        E     ANL     A,ITempB03
0021 6013              JZ      ?C0064
                                           ; SOURCE LINE # 443
                                           ; SOURCE LINE # 444
0023 E4                CLR     A
0024 F500        E     MOV     ITempB05,A
                                           ; SOURCE LINE # 445
0026 850000      E     MOV     typematic,new_keyh
                                           ; SOURCE LINE # 446
0029 E500        E     MOV     A,scan+01H
002B 540F              ANL     A,#0FH
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 39  

002D 4420              ORL     A,#020H
002F F500        E     MOV     scan+01H,A
                                           ; SOURCE LINE # 447
                                           ; SOURCE LINE # 449
0031 120000      R     LCALL   L?0258
0034 F500        E     MOV     etkeytypematic,A
                                           ; SOURCE LINE # 450
0036         ?C0064:
                                           ; SOURCE LINE # 452
0036 7B00              MOV     R3,#00H
0038 7A00        E     MOV     R2,#HIGH new_keyh
003A 7900        E     MOV     R1,#LOW new_keyh
003C 120000      R     LCALL   L?0232
003F 900000      E     MOV     DPTR,#?Send_Scan2?BYTE+01H
0042 E500        E     MOV     A,ITempB05
0044 F0                MOVX    @DPTR,A
0045 120000      E     LCALL   Send_Scan2
                                           ; SOURCE LINE # 453
0048 E4                CLR     A
0049 F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 454
004B F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 455
004D 22                RET     
             ; FUNCTION change_valid (END)

             ; FUNCTION check_tm (BEGIN)
                                           ; SOURCE LINE # 462
                                           ; SOURCE LINE # 463
                                           ; SOURCE LINE # 464
0000 E4                CLR     A
0001 F500        E     MOV     ITempB02,A
                                           ; SOURCE LINE # 465
0003 900000      R     MOV     DPTR,#key
0006 E0                MOVX    A,@DPTR
0007 120000      R     LCALL   L?0231
000A 8002              SJMP    ?C0201
000C         ?C0200:
000C C3                CLR     C
000D 33                RLC     A
000E         ?C0201:
000E D8FC              DJNZ    R0,?C0200
0010 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 466
0012 900000      R     MOV     DPTR,#key
0015 E0                MOVX    A,@DPTR
0016 120000      R     LCALL   L?0249
0019 E6                MOV     A,@R0
001A 5200        E     ANL     ITempB01,A
                                           ; SOURCE LINE # 468
001C E500        E     MOV     A,ITempB01
001E 7005              JNZ     ?C0066
                                           ; SOURCE LINE # 469
                                           ; SOURCE LINE # 470
0020 F500        E     MOV     typematic,A
                                           ; SOURCE LINE # 471
0022 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 472
0025         ?C0066:
                                           ; SOURCE LINE # 474
0025 E500        E     MOV     A,ITempB02
0027 700F              JNZ     ?C0067
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 40  

                                           ; SOURCE LINE # 475
                                           ; SOURCE LINE # 476
0029 AF00        E     MOV     R7,scan+01H
002B 120000      R     LCALL   L?0234
002E F500        E     MOV     scan+01H,A
                                           ; SOURCE LINE # 477
0030 C4                SWAP    A
0031 540F              ANL     A,#0FH
0033 6003              JZ      ?C0067
                                           ; SOURCE LINE # 478
                                           ; SOURCE LINE # 479
0035 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 480
                                           ; SOURCE LINE # 481
0038         ?C0067:
                                           ; SOURCE LINE # 483
0038 E500        E     MOV     A,ITempB02
003A 7014              JNZ     ?C0069
                                           ; SOURCE LINE # 484
                                           ; SOURCE LINE # 485
003C E500        E     MOV     A,scan+01H
003E 540F              ANL     A,#0FH
0040 4420              ORL     A,#020H
0042 F500        E     MOV     scan+01H,A
                                           ; SOURCE LINE # 486
0044 900000      E     MOV     DPTR,#bTMcount
0047 E0                MOVX    A,@DPTR
0048 14                DEC     A
0049 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 487
004A E0                MOVX    A,@DPTR
004B 6003              JZ      ?C0069
                                           ; SOURCE LINE # 488
                                           ; SOURCE LINE # 489
004D 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 490
                                           ; SOURCE LINE # 491
0050         ?C0069:
                                           ; SOURCE LINE # 493
0050 E500        E     MOV     A,ITempB02
0052 701A              JNZ     ?C0072
                                           ; SOURCE LINE # 494
                                           ; SOURCE LINE # 495
0054 900000      E     MOV     DPTR,#bTMrepeat
0057 E0                MOVX    A,@DPTR
0058 900000      E     MOV     DPTR,#bTMcount
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 496
005C 7B01              MOV     R3,#01H
005E 7A00        R     MOV     R2,#HIGH key
0060 7900        R     MOV     R1,#LOW key
0062 120000      R     LCALL   L?0232
0065 900000      E     MOV     DPTR,#?Send_Scan2?BYTE+01H
0068 7402              MOV     A,#02H
006A F0                MOVX    @DPTR,A
006B 120000      E     LCALL   Send_Scan2
                                           ; SOURCE LINE # 497
                                           ; SOURCE LINE # 498
006E         ?C0072:
006E 22                RET     
             ; FUNCTION check_tm (END)

C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 41  

             ; FUNCTION Scan_Init (BEGIN)
                                           ; SOURCE LINE # 503
                                           ; SOURCE LINE # 504
                                           ; SOURCE LINE # 505
                                           ; SOURCE LINE # 506
0000 120000      R     LCALL   L?0250
0003 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 508
0004 30000A      E     JNB     ExtendMatrix,?C0074
                                           ; SOURCE LINE # 509
                                           ; SOURCE LINE # 510
0007 900000      E     MOV     DPTR,#KSOH2
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 512
000B 120000      E     LCALL   Hook_SetGPIOScanPinCtrl
                                           ; SOURCE LINE # 513
000E 120000      E     LCALL   Hook_SetGPIOScanPinL
                                           ; SOURCE LINE # 514
                                           ; SOURCE LINE # 515
0011         ?C0074:
0011 22                RET     
             ; FUNCTION Scan_Init (END)

             ; FUNCTION Enable_Any_Key_Irq (BEGIN)
                                           ; SOURCE LINE # 530
                                           ; SOURCE LINE # 531
                                           ; SOURCE LINE # 532
                                           ; SOURCE LINE # 533
0000 120000      R     LCALL   L?0250
0003 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 535
0004 300007      E     JNB     ExtendMatrix,?C0075
                                           ; SOURCE LINE # 536
                                           ; SOURCE LINE # 537
0007 900000      E     MOV     DPTR,#KSOH2
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 538
000B 120000      E     LCALL   Hook_SetGPIOScanPinL
                                           ; SOURCE LINE # 539
000E         ?C0075:
                                           ; SOURCE LINE # 540
000E 900000      E     MOV     DPTR,#IER1
0011 E0                MOVX    A,@DPTR
0012 4408              ORL     A,#08H
0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 541
0015 22                RET     
             ; FUNCTION Enable_Any_Key_Irq (END)

             ; FUNCTION Start_Scan_Transmission (BEGIN)
                                           ; SOURCE LINE # 552
                                           ; SOURCE LINE # 553
                                           ; SOURCE LINE # 556
0000 020000      E     LJMP    SetServiceSendFlag
             ; FUNCTION Start_Scan_Transmission (END)

             ; FUNCTION Check_Scan_Transmission (BEGIN)
                                           ; SOURCE LINE # 566
                                           ; SOURCE LINE # 567
                                           ; SOURCE LINE # 568
0000 E4                CLR     A
0001 900000      R     MOV     DPTR,#allow_transmission
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 42  

0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 570
0005 7800        E     MOV     R0,#LOW Int_Var
0007 E6                MOV     A,@R0
0008 C4                SWAP    A
0009 13                RRC     A
000A 13                RRC     A
000B 13                RRC     A
000C 5401              ANL     A,#01H
000E 20E017            JB      ACC.0,?C0078
0011 7800        E     MOV     R0,#LOW Flag
0013 E6                MOV     A,@R0
0014 20E011            JB      ACC.0,?C0078
                                           ; SOURCE LINE # 571
                                           ; SOURCE LINE # 573
0017 AF00        E     MOV     R7,scan
0019 EF                MOV     A,R7
001A C4                SWAP    A
001B 540F              ANL     A,#0FH
001D FF                MOV     R7,A
001E E500        E     MOV     A,scan
0020 540F              ANL     A,#0FH
0022 6F                XRL     A,R7
0023 6003              JZ      ?C0078
                                           ; SOURCE LINE # 574
                                           ; SOURCE LINE # 575
0025 7401              MOV     A,#01H
0027 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 576
                                           ; SOURCE LINE # 577
0028         ?C0078:
                                           ; SOURCE LINE # 579
0028 900000      R     MOV     DPTR,#allow_transmission
002B E0                MOVX    A,@DPTR
002C FF                MOV     R7,A
                                           ; SOURCE LINE # 580
002D         ?C0080:
002D 22                RET     
             ; FUNCTION Check_Scan_Transmission (END)

             ; FUNCTION Get_Kbd_Type (BEGIN)
                                           ; SOURCE LINE # 589
                                           ; SOURCE LINE # 590
                                           ; SOURCE LINE # 592
                                           ; SOURCE LINE # 593
                                           ; SOURCE LINE # 594
0000 7F00              MOV     R7,#00H
                                           ; SOURCE LINE # 595
                                           ; SOURCE LINE # 597
                                           ; SOURCE LINE # 598
                                           ; SOURCE LINE # 599
                                           ; SOURCE LINE # 600
0002         ?C0082:
0002 22                RET     
             ; FUNCTION Get_Kbd_Type (END)

             ; FUNCTION Lock_Scan (BEGIN)
                                           ; SOURCE LINE # 608
                                           ; SOURCE LINE # 609
                                           ; SOURCE LINE # 610
0000 7800        E     MOV     R0,#LOW Int_Var
0002 E6                MOV     A,@R0
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 43  

0003 4480              ORL     A,#080H
0005 F6                MOV     @R0,A
                                           ; SOURCE LINE # 612
0006 22                RET     
             ; FUNCTION Lock_Scan (END)

             ; FUNCTION Unlock_Scan (BEGIN)
                                           ; SOURCE LINE # 617
                                           ; SOURCE LINE # 618
                                           ; SOURCE LINE # 619
0000 7800        E     MOV     R0,#LOW Int_Var
0002 E6                MOV     A,@R0
0003 547F              ANL     A,#07FH
0005 F6                MOV     @R0,A
                                           ; SOURCE LINE # 620
0006 22                RET     
             ; FUNCTION Unlock_Scan (END)

             ; FUNCTION CheckKSO1617Support (BEGIN)
                                           ; SOURCE LINE # 622
                                           ; SOURCE LINE # 623
                                           ; SOURCE LINE # 624
0000 E4                CLR     A
0001 900000      E     MOV     DPTR,#ExtendScanPin
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 626
0005 900000      E     MOV     DPTR,#GPCRC3
0008 E0                MOVX    A,@DPTR
0009 54FB              ANL     A,#0FBH
000B 7006              JNZ     ?C0086
                                           ; SOURCE LINE # 627
                                           ; SOURCE LINE # 628
000D 900000      E     MOV     DPTR,#ExtendScanPin
0010 E0                MOVX    A,@DPTR
0011 04                INC     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 629
0013         ?C0086:
                                           ; SOURCE LINE # 631
0013 900000      E     MOV     DPTR,#GPCRC5
0016 E0                MOVX    A,@DPTR
0017 54FB              ANL     A,#0FBH
0019 7006              JNZ     ?C0087
                                           ; SOURCE LINE # 632
                                           ; SOURCE LINE # 633
001B 900000      E     MOV     DPTR,#ExtendScanPin
001E E0                MOVX    A,@DPTR
001F 04                INC     A
0020 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 634
0021         ?C0087:
                                           ; SOURCE LINE # 636
0021 900000      E     MOV     DPTR,#ExtendScanPin
0024 E0                MOVX    A,@DPTR
0025 6004              JZ      ?C0088
                                           ; SOURCE LINE # 637
                                           ; SOURCE LINE # 638
0027 D200        E     SETB    ExtendMatrix
                                           ; SOURCE LINE # 639
0029 8002              SJMP    ?C0089
002B         ?C0088:
                                           ; SOURCE LINE # 641
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 44  

                                           ; SOURCE LINE # 642
002B C200        E     CLR     ExtendMatrix
                                           ; SOURCE LINE # 643
002D         ?C0089:
                                           ; SOURCE LINE # 645
002D 900000      E     MOV     DPTR,#GPCRC3
0030 7404              MOV     A,#04H
0032 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 646
0033 900000      E     MOV     DPTR,#GPCRC5
0036 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 647
0037 22                RET     
             ; FUNCTION CheckKSO1617Support (END)

             ; FUNCTION Init_Kbd (BEGIN)
                                           ; SOURCE LINE # 652
                                           ; SOURCE LINE # 653
                                           ; SOURCE LINE # 656
0000 120000      R     LCALL   Scan_Init
                                           ; SOURCE LINE # 658
0003 120000      E     LCALL   Hook_Setup_Scanner_Pntr
                                           ; SOURCE LINE # 659
0006 120000      R     LCALL   Setup_Diode_Key
                                           ; SOURCE LINE # 661
0009 E4                CLR     A
000A F500        E     MOV     new_keyh,A
                                           ; SOURCE LINE # 662
000C F500        E     MOV     new_keyl,A
                                           ; SOURCE LINE # 664
000E 120000      R     LCALL   ClearExtendKeys
                                           ; SOURCE LINE # 666
0011 120000      E     LCALL   Clear_Fn_Keys
                                           ; SOURCE LINE # 667
0014 120000      R     LCALL   Clear_Key
                                           ; SOURCE LINE # 668
0017 120000      R     LCALL   Clear_Typematic
                                           ; SOURCE LINE # 670
001A 120000      R     LCALL   Enable_Any_Key_Irq
                                           ; SOURCE LINE # 672
                                           ; SOURCE LINE # 673
                                           ; SOURCE LINE # 674
001D 120000      R     LCALL   L?0244
                                           ; SOURCE LINE # 679
0020 22                RET     
             ; FUNCTION Init_Kbd (END)

             ; FUNCTION Setup_Diode_Key (BEGIN)
                                           ; SOURCE LINE # 684
                                           ; SOURCE LINE # 685
                                           ; SOURCE LINE # 686
                                           ; SOURCE LINE # 687
                                           ; SOURCE LINE # 689
0000 E4                CLR     A
0001 900000      E     MOV     DPTR,#diode_key
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 690
                                           ; SOURCE LINE # 692
                                           ; SOURCE LINE # 693
                                           ; SOURCE LINE # 694
                                           ; SOURCE LINE # 695
0005         ?C0094:
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 45  

0005 22                RET     
             ; FUNCTION Setup_Diode_Key (END)

             ; FUNCTION Clear_Key (BEGIN)
                                           ; SOURCE LINE # 701
                                           ; SOURCE LINE # 702
                                           ; SOURCE LINE # 706
;---- Variable 'i' assigned to Register 'R7' ----
0000         ?C0095:
                                           ; SOURCE LINE # 707
                                           ; SOURCE LINE # 708
0000 7F13              MOV     R7,#013H
0002 7800        E     MOV     R0,#LOW bscan_matrix
0004 E4                CLR     A
0005         ?C0202:
0005 F6                MOV     @R0,A
0006 08                INC     R0
0007 DFFC              DJNZ    R7,?C0202
                                           ; SOURCE LINE # 709
0009         ?C0096:
                                           ; SOURCE LINE # 711
0009         ?C0098:
                                           ; SOURCE LINE # 712
                                           ; SOURCE LINE # 713
0009 7F10              MOV     R7,#010H
000B 900000      E     MOV     DPTR,#bKEY_BUFF
000E E4                CLR     A
000F         ?C0203:
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 DFFC              DJNZ    R7,?C0203
                                           ; SOURCE LINE # 714
0013         ?C0099:
                                           ; SOURCE LINE # 716
0013 E500        E     MOV     A,scan
0015 54F0              ANL     A,#0F0H
0017 F500        E     MOV     scan,A
                                           ; SOURCE LINE # 717
0019 540F              ANL     A,#0FH
001B F500        E     MOV     scan,A
                                           ; SOURCE LINE # 718
001D E4                CLR     A
001E F500        E     MOV     typematic,A
                                           ; SOURCE LINE # 719
                                           ; SOURCE LINE # 720
                                           ; SOURCE LINE # 721
0020 120000      R     LCALL   L?0240
                                           ; SOURCE LINE # 722
0023 54F0              ANL     A,#0F0H
0025 F500        E     MOV     scan+02H,A
                                           ; SOURCE LINE # 723
0027 22                RET     
             ; FUNCTION Clear_Key (END)

             ; FUNCTION Clear_Typematic (BEGIN)
                                           ; SOURCE LINE # 729
                                           ; SOURCE LINE # 730
                                           ; SOURCE LINE # 731
0000 E4                CLR     A
0001 F500        E     MOV     typematic,A
                                           ; SOURCE LINE # 732
0003 900000      E     MOV     DPTR,#bTMdelay
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 46  

0006 743C              MOV     A,#03CH
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 733
0009 900000      E     MOV     DPTR,#bTMrepeat
000C 7403              MOV     A,#03H
000E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 734
000F 22                RET     
             ; FUNCTION Clear_Typematic (END)

             ; FUNCTION _Set_Typematic (BEGIN)
                                           ; SOURCE LINE # 757
0000 900000      R     MOV     DPTR,#type_rate
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 758
                                           ; SOURCE LINE # 759
0008 900000      R     MOV     DPTR,#type_rate
000B E0                MOVX    A,@DPTR
000C A3                INC     DPTR
000D E0                MOVX    A,@DPTR
000E 7800        E     MOV     R0,#LOW Save_Typematic
0010 F6                MOV     @R0,A
                                           ; SOURCE LINE # 762
0011 7E00              MOV     R6,#00H
0013 900000      R     MOV     DPTR,#type_rate+01H
0016 E0                MOVX    A,@DPTR
0017 541F              ANL     A,#01FH
0019 2400        R     ADD     A,#LOW repeat_tbl
001B F582              MOV     DPL,A
001D EE                MOV     A,R6
001E 3400        R     ADDC    A,#HIGH repeat_tbl
0020 F583              MOV     DPH,A
0022 E4                CLR     A
0023 93                MOVC    A,@A+DPTR
0024 900000      E     MOV     DPTR,#bTMrepeat
0027 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 765
0028 900000      R     MOV     DPTR,#type_rate
002B E0                MOVX    A,@DPTR
002C FE                MOV     R6,A
002D A3                INC     DPTR
002E E0                MOVX    A,@DPTR
002F 7805              MOV     R0,#05H
0031         ?C0204:
0031 CE                XCH     A,R6
0032 C3                CLR     C
0033 13                RRC     A
0034 CE                XCH     A,R6
0035 13                RRC     A
0036 D8F9              DJNZ    R0,?C0204
0038 7E00              MOV     R6,#00H
003A 5403              ANL     A,#03H
003C 2400        R     ADD     A,#LOW delay_tbl
003E F582              MOV     DPL,A
0040 EE                MOV     A,R6
0041 3400        R     ADDC    A,#HIGH delay_tbl
0043 F583              MOV     DPH,A
0045 E4                CLR     A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 47  

0046 93                MOVC    A,@A+DPTR
0047 900000      E     MOV     DPTR,#bTMdelay
004A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 766
004B 22                RET     
             ; FUNCTION _Set_Typematic (END)

             ; FUNCTION service_scan (BEGIN)
                                           ; SOURCE LINE # 772
                                           ; SOURCE LINE # 773
                                           ; SOURCE LINE # 776
0000 AF00        E     MOV     R7,Timer_A
0002 EF                MOV     A,R7
0003 C4                SWAP    A
0004 540F              ANL     A,#0FH
0006 20E007            JB      ACC.0,?C0104
                                           ; SOURCE LINE # 777
                                           ; SOURCE LINE # 778
0009 AF00        E     MOV     R7,Timer_A
000B EF                MOV     A,R7
000C 4410              ORL     A,#010H
000E F500        E     MOV     Timer_A,A
                                           ; SOURCE LINE # 779
0010         ?C0104:
                                           ; SOURCE LINE # 781
0010 300012      E     JNB     ExtendMatrix,?C0105
                                           ; SOURCE LINE # 782
                                           ; SOURCE LINE # 783
0013 120000      R     LCALL   bScanExtendKeys
0016 EF                MOV     A,R7
0017 C0E0              PUSH    ACC
0019 120000      R     LCALL   scan_keys
001C D0E0              POP     ACC
001E 4F                ORL     A,R7
001F 900000      R     MOV     DPTR,#scan_activity
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 784
0023 8008              SJMP    ?C0106
0025         ?C0105:
                                           ; SOURCE LINE # 786
                                           ; SOURCE LINE # 787
0025 120000      R     LCALL   scan_keys
0028 900000      R     MOV     DPTR,#scan_activity
002B EF                MOV     A,R7
002C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 788
002D         ?C0106:
                                           ; SOURCE LINE # 790
002D 900000      R     MOV     DPTR,#scan_activity
0030 E0                MOVX    A,@DPTR
0031 6028              JZ      ?C0107
                                           ; SOURCE LINE # 791
                                           ; SOURCE LINE # 792
0033 900000      E     MOV     DPTR,#SysPowState
0036 E0                MOVX    A,@DPTR
0037 6433              XRL     A,#033H
0039 7034              JNZ     ?C0110
003B 900000      E     MOV     DPTR,#GPDRB
003E E0                MOVX    A,@DPTR
003F 30E12D            JNB     ACC.1,?C0110
                                           ; SOURCE LINE # 793
                                           ; SOURCE LINE # 796
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 48  

0042 900000      E     MOV     DPTR,#KB_S3Dly
0045 E0                MOVX    A,@DPTR
0046 D3                SETB    C
0047 940A              SUBB    A,#0AH
0049 4008              JC      ?C0109
                                           ; SOURCE LINE # 797
                                           ; SOURCE LINE # 800
004B 7F30              MOV     R7,#030H
004D 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 802
0050 120000      E     LCALL   PulseSBPowerButton
                                           ; SOURCE LINE # 803
0053         ?C0109:
                                           ; SOURCE LINE # 804
0053 900000      E     MOV     DPTR,#KB_S3Dly
0056 E0                MOVX    A,@DPTR
0057 04                INC     A
0058 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 806
                                           ; SOURCE LINE # 807
0059 8014              SJMP    ?C0110
005B         ?C0107:
                                           ; SOURCE LINE # 809
                                           ; SOURCE LINE # 810
005B E4                CLR     A
005C 900000      E     MOV     DPTR,#KB_S3Dly
005F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 811
0060 AF00        E     MOV     R7,Timer_A
0062 EF                MOV     A,R7
0063 54EF              ANL     A,#0EFH
0065 F500        E     MOV     Timer_A,A
                                           ; SOURCE LINE # 812
0067 C200        E     CLR     F_Service_KEY
                                           ; SOURCE LINE # 813
0069 120000      R     LCALL   Enable_Any_Key_Irq
                                           ; SOURCE LINE # 814
                                           ; SOURCE LINE # 815
                                           ; SOURCE LINE # 816
006C 120000      R     LCALL   L?0244
                                           ; SOURCE LINE # 817
006F         ?C0110:
                                           ; SOURCE LINE # 819
006F AF00        E     MOV     R7,Timer_B
0071 EF                MOV     A,R7
0072 C4                SWAP    A
0073 540F              ANL     A,#0FH
0075 20E009            JB      ACC.0,?C0113
                                           ; SOURCE LINE # 820
                                           ; SOURCE LINE # 821
0078 120000      R     LCALL   Check_Scan_Transmission
007B EF                MOV     A,R7
007C 6003              JZ      ?C0113
                                           ; SOURCE LINE # 822
                                           ; SOURCE LINE # 823
007E 120000      R     LCALL   Start_Scan_Transmission
                                           ; SOURCE LINE # 824
                                           ; SOURCE LINE # 825
                                           ; SOURCE LINE # 826
0081         ?C0113:
0081 22                RET     
             ; FUNCTION service_scan (END)
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 49  


             ; FUNCTION Get_Buffer (BEGIN)
                                           ; SOURCE LINE # 842
;---- Variable 'buffer_data' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 843
                                           ; SOURCE LINE # 847
0000 120000      R     LCALL   L?0259
0003 FE                MOV     R6,A
0004 E500        E     MOV     A,scan
0006 540F              ANL     A,#0FH
0008 FD                MOV     R5,A
0009 6E                XRL     A,R6
000A 6025              JZ      ?C0114
                                           ; SOURCE LINE # 848
                                           ; SOURCE LINE # 850
000C E500        E     MOV     A,scan
000E 54F0              ANL     A,#0F0H
0010 FE                MOV     R6,A
0011 ED                MOV     A,R5
0012 04                INC     A
0013 540F              ANL     A,#0FH
0015 4E                ORL     A,R6
0016 F500        E     MOV     scan,A
0018 7400        E     MOV     A,#LOW bKEY_BUFF
001A 2D                ADD     A,R5
001B 120000      R     LCALL   L?0239
001E E0                MOVX    A,@DPTR
001F FF                MOV     R7,A
                                           ; SOURCE LINE # 851
0020 E500        E     MOV     A,scan
0022 540F              ANL     A,#0FH
0024 C3                CLR     C
0025 9410              SUBB    A,#010H
0027 400A              JC      ?C0116
                                           ; SOURCE LINE # 852
                                           ; SOURCE LINE # 853
0029 E500        E     MOV     A,scan
002B 54F0              ANL     A,#0F0H
002D F500        E     MOV     scan,A
                                           ; SOURCE LINE # 854
                                           ; SOURCE LINE # 855
002F 8002              SJMP    ?C0116
0031         ?C0114:
                                           ; SOURCE LINE # 857
                                           ; SOURCE LINE # 858
0031 7FFF              MOV     R7,#0FFH
                                           ; SOURCE LINE # 859
0033         ?C0116:
                                           ; SOURCE LINE # 860
                                           ; SOURCE LINE # 861
0033         ?C0117:
0033 22                RET     
             ; FUNCTION Get_Buffer (END)

             ; FUNCTION Buffer_Mark (BEGIN)
                                           ; SOURCE LINE # 866
                                           ; SOURCE LINE # 867
                                           ; SOURCE LINE # 868
0000 E500        E     MOV     A,scan
0002 54F0              ANL     A,#0F0H
0004 C4                SWAP    A
0005 540F              ANL     A,#0FH
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 50  

0007 FF                MOV     R7,A
0008 E500        E     MOV     A,scan+01H
000A 54F0              ANL     A,#0F0H
000C 4F                ORL     A,R7
000D F500        E     MOV     scan+01H,A
                                           ; SOURCE LINE # 869
000F 22                RET     
             ; FUNCTION Buffer_Mark (END)

             ; FUNCTION _Buffer_Key (BEGIN)
                                           ; SOURCE LINE # 877
;---- Variable 'row_column' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 878
                                           ; SOURCE LINE # 879
0000 900000      R     MOV     DPTR,#ready
0003 7401              MOV     A,#01H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 881
0006 120000      R     LCALL   L?0259
0009 FE                MOV     R6,A
000A 120000      R     LCALL   L?0238
000D EF                MOV     A,R7
000E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 882
000F E500        E     MOV     A,scan
0011 540F              ANL     A,#0FH
0013 FF                MOV     R7,A
0014 EE                MOV     A,R6
0015 04                INC     A
0016 120000      R     LCALL   L?0235
0019 F500        E     MOV     scan,A
                                           ; SOURCE LINE # 884
001B C4                SWAP    A
001C 540F              ANL     A,#0FH
001E C3                CLR     C
001F 9410              SUBB    A,#010H
0021 4006              JC      ?C0119
                                           ; SOURCE LINE # 885
                                           ; SOURCE LINE # 886
0023 E500        E     MOV     A,scan
0025 540F              ANL     A,#0FH
0027 F500        E     MOV     scan,A
                                           ; SOURCE LINE # 887
0029         ?C0119:
                                           ; SOURCE LINE # 890
0029 E500        E     MOV     A,scan
002B 540F              ANL     A,#0FH
002D FF                MOV     R7,A
002E 120000      R     LCALL   L?0260
0031 6F                XRL     A,R7
0032 7019              JNZ     ?C0120
                                           ; SOURCE LINE # 891
                                           ; SOURCE LINE # 892
0034 E500        E     MOV     A,scan+01H
0036 540F              ANL     A,#0FH
0038 C4                SWAP    A
0039 54F0              ANL     A,#0F0H
003B FF                MOV     R7,A
003C E500        E     MOV     A,scan
003E 540F              ANL     A,#0FH
0040 4F                ORL     A,R7
0041 F500        E     MOV     scan,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 51  

                                           ; SOURCE LINE # 893
0043 C4                SWAP    A
0044 120000      R     LCALL   L?0238
0047 E4                CLR     A
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 894
0049 900000      R     MOV     DPTR,#ready
004C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 895
004D         ?C0120:
                                           ; SOURCE LINE # 897
004D 900000      R     MOV     DPTR,#ready
0050 E0                MOVX    A,@DPTR
0051 FF                MOV     R7,A
                                           ; SOURCE LINE # 898
0052         ?C0121:
0052 22                RET     
             ; FUNCTION _Buffer_Key (END)

             ; FUNCTION _Buffer_String (BEGIN)
                                           ; SOURCE LINE # 910
0000 900000      R     MOV     DPTR,#pntr
0003 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 911
                                           ; SOURCE LINE # 912
;---- Variable 'error' assigned to Register 'R5' ----
0006 E4                CLR     A
0007 FD                MOV     R5,A
0008         ?C0122:
                                           ; SOURCE LINE # 914
0008 900000      R     MOV     DPTR,#pntr
000B 120000      E     LCALL   ?C?PLDXDATA
000E 120000      E     LCALL   ?C?CLDPTR
0011 601A              JZ      ?C0123
0013 ED                MOV     A,R5
0014 7017              JNZ     ?C0123
                                           ; SOURCE LINE # 915
                                           ; SOURCE LINE # 916
0016 900000      R     MOV     DPTR,#pntr
0019 75F001            MOV     B,#01H
001C 120000      E     LCALL   ?C?PLDIXDATA
001F 120000      E     LCALL   ?C?CLDPTR
0022 FF                MOV     R7,A
0023 120000      R     LCALL   _Buffer_Key
0026 EF                MOV     A,R7
0027 70DF              JNZ     ?C0122
                                           ; SOURCE LINE # 917
0029 7D80              MOV     R5,#080H
                                           ; SOURCE LINE # 918
                                           ; SOURCE LINE # 919
002B 80DB              SJMP    ?C0122
002D         ?C0123:
                                           ; SOURCE LINE # 921
002D CF                XCH     A,R7
002E ED                MOV     A,R5
002F CF                XCH     A,R7
                                           ; SOURCE LINE # 922
0030         ?C0125:
0030 22                RET     
             ; FUNCTION _Buffer_String (END)

             ; FUNCTION bScanExtendKeys (BEGIN)
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 52  

                                           ; SOURCE LINE # 930
                                           ; SOURCE LINE # 931
                                           ; SOURCE LINE # 932
0000 E4                CLR     A
0001 F500        E     MOV     ITempB06,A
                                           ; SOURCE LINE # 933
0003 E500        E     MOV     A,extendscan+02H
0005 54DF              ANL     A,#0DFH
0007 F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 934
0009 54EF              ANL     A,#0EFH
000B F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 935
000D 54BF              ANL     A,#0BFH
000F F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 937
0011 E500        E     MOV     A,etkeytypematic
0013 6012              JZ      ?C0126
                                           ; SOURCE LINE # 938
                                           ; SOURCE LINE # 939
0015 7800        R     MOV     R0,#LOW ?CheckEtKeystm?BYTE
0017 7C00        R     MOV     R4,#HIGH ?CheckEtKeystm?BYTE
0019 7D01              MOV     R5,#01H
001B 7B00              MOV     R3,#00H
001D 7A00        E     MOV     R2,#HIGH etkeytypematic
001F 7900        E     MOV     R1,#LOW etkeytypematic
0021 120000      R     LCALL   L?0233
0024 120000      R     LCALL   CheckEtKeystm
                                           ; SOURCE LINE # 940
0027         ?C0126:
                                           ; SOURCE LINE # 942
0027 E500        E     MOV     A,new_extendkey
0029 600C              JZ      ?C0127
                                           ; SOURCE LINE # 943
                                           ; SOURCE LINE # 944
002B E500        E     MOV     A,extendscan+02H
002D 4410              ORL     A,#010H
002F F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 945
0031 120000      R     LCALL   DebounceExtendkey
                                           ; SOURCE LINE # 946
0034 750001      E     MOV     ITempB06,#01H
                                           ; SOURCE LINE # 947
0037         ?C0127:
                                           ; SOURCE LINE # 949
0037 E500        E     MOV     A,ITempB06
0039 7047              JNZ     ?C0128
                                           ; SOURCE LINE # 950
                                           ; SOURCE LINE # 951
003B F500        E     MOV     ITempB01,A
003D         ?C0129:
003D 900000      E     MOV     DPTR,#ExtendScanPin
0040 E0                MOVX    A,@DPTR
0041 FF                MOV     R7,A
0042 E500        E     MOV     A,ITempB01
0044 C3                CLR     C
0045 9F                SUBB    A,R7
0046 503A              JNC     ?C0128
                                           ; SOURCE LINE # 952
                                           ; SOURCE LINE # 953
0048 AF00        E     MOV     R7,ITempB01
004A 120000      R     LCALL   _SetExtendScanLines
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 53  

                                           ; SOURCE LINE # 954
004D 120000      R     LCALL   CapDelay
                                           ; SOURCE LINE # 955
0050 120000      R     LCALL   CapDelay
                                           ; SOURCE LINE # 956
                                           ; SOURCE LINE # 957
0053 120000      R     LCALL   L?0255
                                           ; SOURCE LINE # 958
0056 AF00        E     MOV     R7,ITempB01
0058 7400        E     MOV     A,#LOW bscan_matrix+010H
                                           ; SOURCE LINE # 959
005A 120000      R     LCALL   L?0247
005D 6010              JZ      ?C0132
                                           ; SOURCE LINE # 960
                                           ; SOURCE LINE # 961
005F AF00        E     MOV     R7,ITempB02
0061 7E00              MOV     R6,#00H
0063 AD00        E     MOV     R5,ITempB01
0065 ED                MOV     A,R5
0066 2410              ADD     A,#010H
0068 FD                MOV     R5,A
0069 E4                CLR     A
006A 33                RLC     A
006B FC                MOV     R4,A
006C 120000      R     LCALL   _CheckExtendKeys
                                           ; SOURCE LINE # 962
006F         ?C0132:
                                           ; SOURCE LINE # 964
006F AF00        E     MOV     R7,ITempB01
0071 7400        E     MOV     A,#LOW bscan_matrix+010H
0073 2F                ADD     A,R7
0074 F8                MOV     R0,A
0075 E6                MOV     A,@R0
0076 6006              JZ      ?C0131
                                           ; SOURCE LINE # 965
                                           ; SOURCE LINE # 966
0078 E500        E     MOV     A,extendscan+02H
007A 4440              ORL     A,#040H
007C F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 967
                                           ; SOURCE LINE # 968
007E         ?C0131:
007E 0500        E     INC     ITempB01
0080 80BB              SJMP    ?C0129
                                           ; SOURCE LINE # 969
0082         ?C0128:
                                           ; SOURCE LINE # 971
0082 AF00        E     MOV     R7,extendstatus
0084 120000      R     LCALL   L?0242
0087 30E02C            JNB     ACC.0,?C0134
                                           ; SOURCE LINE # 972
                                           ; SOURCE LINE # 973
008A AF00        E     MOV     R7,extendstatus
008C EF                MOV     A,R7
008D 54F7              ANL     A,#0F7H
008F F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 974
0091 E500        E     MOV     A,extendstatus
0093 5407              ANL     A,#07H
0095 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 975
0097 E500        E     MOV     A,ITempB01
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 54  

0099 7013              JNZ     ?C0135
                                           ; SOURCE LINE # 976
                                           ; SOURCE LINE # 977
009B AF00        E     MOV     R7,new_extendkey
009D 120000      R     LCALL   L?0230
00A0 8002              SJMP    ?C0206
00A2         ?C0205:
00A2 C3                CLR     C
00A3 33                RLC     A
00A4         ?C0206:
00A4 D8FC              DJNZ    R0,?C0205
00A6 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 978
00A8 900000      E     MOV     DPTR,#diode_key
00AB E0                MOVX    A,@DPTR
00AC 5200        E     ANL     ITempB01,A
                                           ; SOURCE LINE # 979
00AE         ?C0135:
                                           ; SOURCE LINE # 980
00AE E500        E     MOV     A,ITempB01
00B0 7004              JNZ     ?C0134
                                           ; SOURCE LINE # 981
                                           ; SOURCE LINE # 982
00B2 F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 983
00B4 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 984
                                           ; SOURCE LINE # 985
00B6         ?C0134:
                                           ; SOURCE LINE # 987
00B6 AF00        E     MOV     R7,extendscan+02H
00B8 EF                MOV     A,R7
00B9 C4                SWAP    A
00BA 13                RRC     A
00BB 5401              ANL     A,#01H
00BD FF                MOV     R7,A
00BE AE00        E     MOV     R6,extendscan+02H
00C0 EE                MOV     A,R6
00C1 AE00        E     MOV     R6,extendscan+02H
00C3 120000      R     LCALL   L?0243
                                           ; SOURCE LINE # 988
00C6         ?C0137:
00C6 22                RET     
             ; FUNCTION bScanExtendKeys (END)

             ; FUNCTION _SetExtendScanLines (BEGIN)
                                           ; SOURCE LINE # 993
;---- Variable 'scan_line' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 994
                                           ; SOURCE LINE # 995
0000 EF                MOV     A,R7
0001 C3                CLR     C
0002 9402              SUBB    A,#02H
0004 5016              JNC     ?C0138
                                           ; SOURCE LINE # 996
                                           ; SOURCE LINE # 997
                                           ; SOURCE LINE # 998
0006 120000      R     LCALL   L?0236
                                           ; SOURCE LINE # 999
0009 120000      R     LCALL   L?0257
000C 8002              SJMP    ?C0208
000E         ?C0207:
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 55  

000E C3                CLR     C
000F 33                RLC     A
0010         ?C0208:
0010 D8FC              DJNZ    R0,?C0207
0012 F4                CPL     A
0013 900000      E     MOV     DPTR,#KSOH2
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1000
0017 120000      E     LCALL   Hook_SetGPIOScanPinH
                                           ; SOURCE LINE # 1001
001A 800A              SJMP    ?C0139
001C         ?C0138:
                                           ; SOURCE LINE # 1003
                                           ; SOURCE LINE # 1004
                                           ; SOURCE LINE # 1005
001C 120000      R     LCALL   L?0237
                                           ; SOURCE LINE # 1006
001F 900000      E     MOV     DPTR,#KSOH2
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1007
0023 120000      E     LCALL   Hook_SetGPIOScanPinL
                                           ; SOURCE LINE # 1008
0026         ?C0139:
                                           ; SOURCE LINE # 1009
0026 020000      R     LJMP    CapDelay
             ; FUNCTION _SetExtendScanLines (END)

             ; FUNCTION _CheckExtendKeys (BEGIN)
                                           ; SOURCE LINE # 1015
0000 900000      R     MOV     DPTR,#KSI_bit_num
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
0008 A3                INC     DPTR
0009 EC                MOV     A,R4
000A F0                MOVX    @DPTR,A
000B A3                INC     DPTR
000C ED                MOV     A,R5
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1016
                                           ; SOURCE LINE # 1020
;---- Variable 'flag' assigned to Register 'R3' ----
000E E4                CLR     A
000F FB                MOV     R3,A
                                           ; SOURCE LINE # 1021
0010 AF00        E     MOV     R7,extendstatus
0012 120000      R     LCALL   L?0242
0015 30E003            JNB     ACC.0,?C0141
                                           ; SOURCE LINE # 1022
                                           ; SOURCE LINE # 1023
0018 0B                INC     R3
                                           ; SOURCE LINE # 1024
0019 801C              SJMP    ?C0142
001B         ?C0141:
                                           ; SOURCE LINE # 1026
                                           ; SOURCE LINE # 1027
001B 900000      R     MOV     DPTR,#scan_address
001E 120000      R     LCALL   L?0245
0021 F4                CPL     A
0022 FF                MOV     R7,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 56  

0023 900000      R     MOV     DPTR,#KSI_bit_num
0026 A3                INC     DPTR
0027 E0                MOVX    A,@DPTR
0028 5F                ANL     A,R7
0029 FF                MOV     R7,A
;---- Variable 'change_make_key' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 1028
002A 7003              JNZ     ?C0143
                                           ; SOURCE LINE # 1029
                                           ; SOURCE LINE # 1030
002C FB                MOV     R3,A
                                           ; SOURCE LINE # 1031
002D 8008              SJMP    ?C0142
002F         ?C0143:
                                           ; SOURCE LINE # 1032
002F 120000      R     LCALL   _find_paths
0032 EF                MOV     A,R7
0033 6002              JZ      ?C0142
                                           ; SOURCE LINE # 1033
                                           ; SOURCE LINE # 1034
0035 7B01              MOV     R3,#01H
                                           ; SOURCE LINE # 1035
                                           ; SOURCE LINE # 1036
0037         ?C0142:
                                           ; SOURCE LINE # 1038
0037 EB                MOV     A,R3
0038 6020              JZ      ?C0146
                                           ; SOURCE LINE # 1039
                                           ; SOURCE LINE # 1040
003A AF00        E     MOV     R7,extendstatus
003C EF                MOV     A,R7
003D 4408              ORL     A,#08H
003F F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1041
0041 900000      R     MOV     DPTR,#scan_address
0044 A3                INC     DPTR
0045 E0                MOVX    A,@DPTR
0046 2400        E     ADD     A,#LOW bscan_matrix
0048 F8                MOV     R0,A
0049 E6                MOV     A,@R0
004A FF                MOV     R7,A
004B 900000      E     MOV     DPTR,#diode_key
004E E0                MOVX    A,@DPTR
004F 4F                ORL     A,R7
0050 FF                MOV     R7,A
0051 900000      R     MOV     DPTR,#KSI_bit_num
0054 E4                CLR     A
0055 F0                MOVX    @DPTR,A
0056 A3                INC     DPTR
0057 E0                MOVX    A,@DPTR
0058 5F                ANL     A,R7
0059 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1042
005A         ?C0146:
                                           ; SOURCE LINE # 1044
005A E4                CLR     A
005B F500        E     MOV     ITempB03,A
005D         ?C0147:
                                           ; SOURCE LINE # 1045
005D 900000      R     MOV     DPTR,#KSI_bit_num
0060 E0                MOVX    A,@DPTR
0061 FE                MOV     R6,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 57  

0062 A3                INC     DPTR
0063 E0                MOVX    A,@DPTR
0064 FF                MOV     R7,A
0065 4E                ORL     A,R6
0066 6065              JZ      ?C0154
                                           ; SOURCE LINE # 1046
                                           ; SOURCE LINE # 1047
0068 EF                MOV     A,R7
0069 30E051            JNB     ACC.0,?C0149
                                           ; SOURCE LINE # 1048
                                           ; SOURCE LINE # 1049
006C A3                INC     DPTR
006D 120000      R     LCALL   L?0245
0070 FB                MOV     R3,A
0071 7A00              MOV     R2,#00H
0073 AF00        E     MOV     R7,ITempB03
0075 7401              MOV     A,#01H
0077 7E00              MOV     R6,#00H
0079 C8                XCH     A,R0
007A EF                MOV     A,R7
007B C8                XCH     A,R0
007C 08                INC     R0
007D 8005              SJMP    ?C0210
007F         ?C0209:
007F C3                CLR     C
0080 33                RLC     A
0081 CE                XCH     A,R6
0082 33                RLC     A
0083 CE                XCH     A,R6
0084         ?C0210:
0084 D8F9              DJNZ    R0,?C0209
0086 FF                MOV     R7,A
0087 EE                MOV     A,R6
0088 5A                ANL     A,R2
0089 FE                MOV     R6,A
008A EF                MOV     A,R7
008B 5B                ANL     A,R3
008C 4E                ORL     A,R6
008D 6013              JZ      ?C0150
                                           ; SOURCE LINE # 1050
                                           ; SOURCE LINE # 1051
008F AF00        E     MOV     R7,extendscan+02H
0091 EF                MOV     A,R7
0092 C4                SWAP    A
0093 13                RRC     A
0094 5407              ANL     A,#07H
0096 20E024            JB      ACC.0,?C0149
                                           ; SOURCE LINE # 1052
                                           ; SOURCE LINE # 1053
0099 EF                MOV     A,R7
009A 4420              ORL     A,#020H
009C F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 1054
009E 7B01              MOV     R3,#01H
                                           ; SOURCE LINE # 1055
                                           ; SOURCE LINE # 1056
00A0 8016              SJMP    ?C0222
00A2         ?C0150:
                                           ; SOURCE LINE # 1058
                                           ; SOURCE LINE # 1059
00A2 AF00        E     MOV     R7,extendscan+02H
00A4 EF                MOV     A,R7
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 58  

00A5 C4                SWAP    A
00A6 540F              ANL     A,#0FH
00A8 20E012            JB      ACC.0,?C0149
                                           ; SOURCE LINE # 1060
                                           ; SOURCE LINE # 1061
00AB EF                MOV     A,R7
00AC 4410              ORL     A,#010H
00AE F500        E     MOV     extendscan+02H,A
                                           ; SOURCE LINE # 1062
00B0 900000      R     MOV     DPTR,#scan_address
00B3 A3                INC     DPTR
00B4 E0                MOVX    A,@DPTR
00B5 FD                MOV     R5,A
00B6 E4                CLR     A
00B7 FB                MOV     R3,A
00B8         ?C0222:
00B8 AF00        E     MOV     R7,ITempB03
00BA 120000      R     LCALL   _ExtendKeyDebounce
                                           ; SOURCE LINE # 1063
                                           ; SOURCE LINE # 1064
                                           ; SOURCE LINE # 1065
00BD         ?C0149:
                                           ; SOURCE LINE # 1066
00BD 0500        E     INC     ITempB03
                                           ; SOURCE LINE # 1067
00BF 900000      R     MOV     DPTR,#KSI_bit_num
00C2 E0                MOVX    A,@DPTR
00C3 A2E7              MOV     C,ACC.7
00C5 13                RRC     A
00C6 F0                MOVX    @DPTR,A
00C7 A3                INC     DPTR
00C8 E0                MOVX    A,@DPTR
00C9 13                RRC     A
00CA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1068
00CB 8090              SJMP    ?C0147
                                           ; SOURCE LINE # 1069
00CD         ?C0154:
00CD 22                RET     
             ; FUNCTION _CheckExtendKeys (END)

             ; FUNCTION _ExtendKeyDebounce (BEGIN)
                                           ; SOURCE LINE # 1074
;---- Variable 'KSI_bit_num' assigned to Register 'R7' ----
;---- Variable 'event' assigned to Register 'R3' ----
;---- Variable 'scan_address' assigned to Register 'R5' ----
                                           ; SOURCE LINE # 1075
                                           ; SOURCE LINE # 1076
0000 ED                MOV     A,R5
0001 24F0              ADD     A,#0F0H
0003 AD00        E     MOV     R5,new_extendkey
0005 120000      R     LCALL   L?0254
0008 F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 1077
000A EF                MOV     A,R7
000B 5407              ANL     A,#07H
000D FF                MOV     R7,A
000E AE00        E     MOV     R6,new_extendkey
0010 EE                MOV     A,R6
0011 54F8              ANL     A,#0F8H
0013 4F                ORL     A,R7
0014 F500        E     MOV     new_extendkey,A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 59  

                                           ; SOURCE LINE # 1078
0016 AF00        E     MOV     R7,new_extendkey
0018 EF                MOV     A,R7
0019 4408              ORL     A,#08H
001B F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 1079
001D AF00        E     MOV     R7,extendstatus
001F EF                MOV     A,R7
0020 54FE              ANL     A,#0FEH
0022 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1080
0024 AF00        E     MOV     R7,extendstatus
0026 EF                MOV     A,R7
0027 54EF              ANL     A,#0EFH
0029 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1082
002B EB                MOV     A,R3
002C AF00        E     MOV     R7,extendstatus
002E 7005              JNZ     ?C0155
                                           ; SOURCE LINE # 1083
                                           ; SOURCE LINE # 1084
0030 EF                MOV     A,R7
0031 54FD              ANL     A,#0FDH
                                           ; SOURCE LINE # 1085
                                           ; SOURCE LINE # 1086
0033 8003              SJMP    ?C0223
0035         ?C0155:
                                           ; SOURCE LINE # 1088
                                           ; SOURCE LINE # 1089
0035 EF                MOV     A,R7
0036 4402              ORL     A,#02H
0038         ?C0223:
0038 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1090
003A AF00        E     MOV     R7,extendstatus
003C EF                MOV     A,R7
003D 541F              ANL     A,#01FH
003F 4420              ORL     A,#020H
0041 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1091
                                           ; SOURCE LINE # 1092
0043         ?C0157:
0043 22                RET     
             ; FUNCTION _ExtendKeyDebounce (END)

             ; FUNCTION DebounceExtendkey (BEGIN)
                                           ; SOURCE LINE # 1095
                                           ; SOURCE LINE # 1096
                                           ; SOURCE LINE # 1097
0000 AF00        E     MOV     R7,new_extendkey
0002 EF                MOV     A,R7
0003 C4                SWAP    A
0004 540F              ANL     A,#0FH
0006 FF                MOV     R7,A
0007 120000      R     LCALL   _SetExtendScanLines
                                           ; SOURCE LINE # 1098
000A 120000      R     LCALL   Read_Scan_Lines
000D 8F00        E     MOV     ITempB04,R7
                                           ; SOURCE LINE # 1099
000F 6300FF      E     XRL     ITempB04,#0FFH
                                           ; SOURCE LINE # 1100
0012 AF00        E     MOV     R7,new_extendkey
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 60  

0014 120000      R     LCALL   L?0230
0017 8002              SJMP    ?C0212
0019         ?C0211:
0019 C3                CLR     C
001A 33                RLC     A
001B         ?C0212:
001B D8FC              DJNZ    R0,?C0211
001D F500        E     MOV     ITempB05,A
                                           ; SOURCE LINE # 1101
001F E500        E     MOV     A,ITempB04
0021 5200        E     ANL     ITempB05,A
                                           ; SOURCE LINE # 1103
0023 E500        E     MOV     A,ITempB05
0025 600C              JZ      ?C0158
                                           ; SOURCE LINE # 1104
                                           ; SOURCE LINE # 1105
0027 AF00        E     MOV     R7,extendstatus
0029 EF                MOV     A,R7
002A C3                CLR     C
002B 13                RRC     A
002C AF00        E     MOV     R7,extendstatus
002E 20E00C            JB      ACC.0,?C0225
                                           ; SOURCE LINE # 1106
                                           ; SOURCE LINE # 1107
                                           ; SOURCE LINE # 1108
0031 8011              SJMP    ?C0224
0033         ?C0158:
                                           ; SOURCE LINE # 1115
                                           ; SOURCE LINE # 1116
0033 AF00        E     MOV     R7,extendstatus
0035 EF                MOV     A,R7
0036 C3                CLR     C
0037 13                RRC     A
0038 AF00        E     MOV     R7,extendstatus
003A 20E007            JB      ACC.0,?C0162
                                           ; SOURCE LINE # 1117
                                           ; SOURCE LINE # 1118
003D         ?C0225:
003D EF                MOV     A,R7
003E 54EF              ANL     A,#0EFH
0040 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1119
0042 8005              SJMP    ?C0161
0044         ?C0162:
                                           ; SOURCE LINE # 1121
                                           ; SOURCE LINE # 1122
0044         ?C0224:
0044 EF                MOV     A,R7
0045 4410              ORL     A,#010H
0047 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1123
                                           ; SOURCE LINE # 1124
0049         ?C0161:
                                           ; SOURCE LINE # 1126
0049 AF00        E     MOV     R7,extendstatus
004B EF                MOV     A,R7
004C 20E034            JB      ACC.0,?C0164
                                           ; SOURCE LINE # 1127
                                           ; SOURCE LINE # 1128
004F AF00        E     MOV     R7,extendstatus
0051 EF                MOV     A,R7
0052 C4                SWAP    A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 61  

0053 13                RRC     A
0054 5407              ANL     A,#07H
0056 6018              JZ      ?C0165
                                           ; SOURCE LINE # 1129
                                           ; SOURCE LINE # 1130
0058 AF00        E     MOV     R7,extendstatus
005A EF                MOV     A,R7
005B C4                SWAP    A
005C 13                RRC     A
005D 5407              ANL     A,#07H
005F FE                MOV     R6,A
0060 EF                MOV     A,R7
0061 541F              ANL     A,#01FH
0063 FF                MOV     R7,A
0064 EE                MOV     A,R6
0065 14                DEC     A
0066 5407              ANL     A,#07H
0068 C4                SWAP    A
0069 33                RLC     A
006A 54E0              ANL     A,#0E0H
006C 4F                ORL     A,R7
006D F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1131
006F 22                RET     
0070         ?C0165:
                                           ; SOURCE LINE # 1133
                                           ; SOURCE LINE # 1134
0070 AF00        E     MOV     R7,extendstatus
0072 EF                MOV     A,R7
0073 C4                SWAP    A
0074 540F              ANL     A,#0FH
0076 20E002            JB      ACC.0,?C0167
                                           ; SOURCE LINE # 1135
                                           ; SOURCE LINE # 1136
                                           ; SOURCE LINE # 1137
                                           ; SOURCE LINE # 1138
0079 8011              SJMP    ?C0226
007B         ?C0167:
                                           ; SOURCE LINE # 1140
                                           ; SOURCE LINE # 1141
007B AF00        E     MOV     R7,extendstatus
007D EF                MOV     A,R7
007E 4401              ORL     A,#01H
0080 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1142
                                           ; SOURCE LINE # 1143
                                           ; SOURCE LINE # 1144
0082 22                RET     
0083         ?C0164:
                                           ; SOURCE LINE # 1146
                                           ; SOURCE LINE # 1147
0083 AF00        E     MOV     R7,extendstatus
0085 EF                MOV     A,R7
0086 C4                SWAP    A
0087 540F              ANL     A,#0FH
0089 20E006            JB      ACC.0,?C0170
                                           ; SOURCE LINE # 1148
                                           ; SOURCE LINE # 1149
008C         ?C0226:
008C E4                CLR     A
008D F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 1150
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 62  

008F F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1151
0091 22                RET     
0092         ?C0170:
                                           ; SOURCE LINE # 1153
                                           ; SOURCE LINE # 1154
0092 120000      R     LCALL   CheckExtendKeyValid
                                           ; SOURCE LINE # 1155
                                           ; SOURCE LINE # 1156
                                           ; SOURCE LINE # 1157
0095         ?C0172:
0095 22                RET     
             ; FUNCTION DebounceExtendkey (END)

             ; FUNCTION CheckExtendKeyValid (BEGIN)
                                           ; SOURCE LINE # 1163
                                           ; SOURCE LINE # 1164
                                           ; SOURCE LINE # 1165
0000 AF00        E     MOV     R7,new_extendkey
0002 120000      R     LCALL   L?0230
0005 8002              SJMP    ?C0214
0007         ?C0213:
0007 C3                CLR     C
0008 33                RLC     A
0009         ?C0214:
0009 D8FC              DJNZ    R0,?C0213
000B F500        E     MOV     ITempB02,A
                                           ; SOURCE LINE # 1166
000D 120000      R     LCALL   L?0252
0010 E6                MOV     A,@R0
0011 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 1167
0013 E500        E     MOV     A,ITempB02
0015 6200        E     XRL     ITempB01,A
                                           ; SOURCE LINE # 1168
0017 120000      R     LCALL   L?0252
001A A600        E     MOV     @R0,ITempB01
                                           ; SOURCE LINE # 1170
001C 750001      E     MOV     ITempB03,#01H
                                           ; SOURCE LINE # 1171
001F E500        E     MOV     A,ITempB02
0021 5500        E     ANL     A,ITempB01
0023 6013              JZ      ?C0173
                                           ; SOURCE LINE # 1172
                                           ; SOURCE LINE # 1173
0025 E4                CLR     A
0026 F500        E     MOV     ITempB03,A
                                           ; SOURCE LINE # 1174
0028 850000      E     MOV     etkeytypematic,new_extendkey
                                           ; SOURCE LINE # 1175
002B E500        E     MOV     A,extendscan+01H
002D 540F              ANL     A,#0FH
002F 4420              ORL     A,#020H
0031 F500        E     MOV     extendscan+01H,A
                                           ; SOURCE LINE # 1176
                                           ; SOURCE LINE # 1178
0033 120000      R     LCALL   L?0258
0036 F500        E     MOV     typematic,A
                                           ; SOURCE LINE # 1179
0038         ?C0173:
                                           ; SOURCE LINE # 1181
0038 7800        R     MOV     R0,#LOW ?Send_EtScan2?BYTE
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 63  

003A 7C00        R     MOV     R4,#HIGH ?Send_EtScan2?BYTE
003C 7D01              MOV     R5,#01H
003E 7B00              MOV     R3,#00H
0040 7A00        E     MOV     R2,#HIGH new_extendkey
0042 7900        E     MOV     R1,#LOW new_extendkey
0044 120000      R     LCALL   L?0233
0047 900000      R     MOV     DPTR,#?Send_EtScan2?BYTE+01H
004A E500        E     MOV     A,ITempB03
004C F0                MOVX    @DPTR,A
004D 120000      R     LCALL   Send_EtScan2
                                           ; SOURCE LINE # 1182
0050 E4                CLR     A
0051 F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 1183
0053 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1184
0055 22                RET     
             ; FUNCTION CheckExtendKeyValid (END)

             ; FUNCTION Send_EtScan2 (BEGIN)
                                           ; SOURCE LINE # 1189
                                           ; SOURCE LINE # 1190
                                           ; SOURCE LINE # 1191
0000 900000      E     MOV     DPTR,#UtilityFlag
0003 E0                MOVX    A,@DPTR
0004 30E626            JNB     ACC.6,?C0175
                                           ; SOURCE LINE # 1192
                                           ; SOURCE LINE # 1193
0007 900000      E     MOV     DPTR,#KeyScanACK
000A E0                MOVX    A,@DPTR
000B F4                CPL     A
000C 705A              JNZ     ?C0179
                                           ; SOURCE LINE # 1194
                                           ; SOURCE LINE # 1195
000E 900000      R     MOV     DPTR,#event
0011 E0                MOVX    A,@DPTR
0012 7054              JNZ     ?C0179
                                           ; SOURCE LINE # 1196
                                           ; SOURCE LINE # 1197
0014 120000      R     LCALL   L?0261
0017 900000      E     MOV     DPTR,#KeyScanKSI
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1198
001B 900000      R     MOV     DPTR,#key
001E E0                MOVX    A,@DPTR
001F C4                SWAP    A
0020 540F              ANL     A,#0FH
0022 900000      E     MOV     DPTR,#KeyScanKSO
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1199
0026 900000      E     MOV     DPTR,#KeyScanACK
0029 7444              MOV     A,#044H
002B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1200
                                           ; SOURCE LINE # 1201
                                           ; SOURCE LINE # 1202
002C 22                RET     
002D         ?C0175:
                                           ; SOURCE LINE # 1204
                                           ; SOURCE LINE # 1205
002D 120000      R     LCALL   L?0261
0030 75F003            MOV     B,#03H
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 64  

0033 A4                MUL     AB
0034 FF                MOV     R7,A
0035 E0                MOVX    A,@DPTR
0036 C4                SWAP    A
0037 540F              ANL     A,#0FH
0039 2F                ADD     A,R7
003A F500        E     MOV     ITempB02,A
                                           ; SOURCE LINE # 1207
003C AF00        E     MOV     R7,ITempB02
003E 7800        E     MOV     R0,#LOW Extendkey_RAM_Pntr
0040 E6                MOV     A,@R0
0041 FC                MOV     R4,A
0042 08                INC     R0
0043 E6                MOV     A,@R0
0044 8C83              MOV     DPH,R4
0046 2F                ADD     A,R7
0047 F582              MOV     DPL,A
0049 E4                CLR     A
004A 3583              ADDC    A,DPH
004C F583              MOV     DPH,A
004E E0                MOVX    A,@DPTR
004F F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 1212
0051 120000      R     LCALL   L?0262
0054 FF                MOV     R7,A
0055 E0                MOVX    A,@DPTR
0056 FE                MOV     R6,A
0057 C4                SWAP    A
0058 540F              ANL     A,#0FH
005A FD                MOV     R5,A
005B 120000      E     LCALL   _Et_Hook_keyboard
                                           ; SOURCE LINE # 1213
005E 900000      R     MOV     DPTR,#event
0061 E0                MOVX    A,@DPTR
0062 FD                MOV     R5,A
0063 AF00        E     MOV     R7,ITempB01
0065 120000      E     LCALL   _Send_Key
                                           ; SOURCE LINE # 1214
                                           ; SOURCE LINE # 1215
0068         ?C0179:
0068 22                RET     
             ; FUNCTION Send_EtScan2 (END)

             ; FUNCTION ClearExtendKeys (BEGIN)
                                           ; SOURCE LINE # 1220
                                           ; SOURCE LINE # 1221
                                           ; SOURCE LINE # 1222
0000 E4                CLR     A
0001 F500        E     MOV     new_extendkey,A
                                           ; SOURCE LINE # 1223
0003 F500        E     MOV     extendstatus,A
                                           ; SOURCE LINE # 1224
0005 F500        E     MOV     etkeytypematic,A
                                           ; SOURCE LINE # 1225
0007 22                RET     
             ; FUNCTION ClearExtendKeys (END)

             ; FUNCTION CheckEtKeystm (BEGIN)
                                           ; SOURCE LINE # 1230
                                           ; SOURCE LINE # 1231
                                           ; SOURCE LINE # 1232
0000 E4                CLR     A
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 65  

0001 F500        E     MOV     ITempB02,A
                                           ; SOURCE LINE # 1233
0003 900000      R     MOV     DPTR,#key
0006 E0                MOVX    A,@DPTR
0007 120000      R     LCALL   L?0231
000A 8002              SJMP    ?C0216
000C         ?C0215:
000C C3                CLR     C
000D 33                RLC     A
000E         ?C0216:
000E D8FC              DJNZ    R0,?C0215
0010 F500        E     MOV     ITempB01,A
                                           ; SOURCE LINE # 1234
0012 900000      R     MOV     DPTR,#key
0015 E0                MOVX    A,@DPTR
0016 120000      R     LCALL   L?0253
0019 E6                MOV     A,@R0
001A 5200        E     ANL     ITempB01,A
                                           ; SOURCE LINE # 1236
001C E500        E     MOV     A,ITempB01
001E 7005              JNZ     ?C0181
                                           ; SOURCE LINE # 1237
                                           ; SOURCE LINE # 1238
0020 F500        E     MOV     etkeytypematic,A
                                           ; SOURCE LINE # 1239
0022 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 1240
0025         ?C0181:
                                           ; SOURCE LINE # 1242
0025 E500        E     MOV     A,ITempB02
0027 700F              JNZ     ?C0182
                                           ; SOURCE LINE # 1243
                                           ; SOURCE LINE # 1244
0029 AF00        E     MOV     R7,extendscan+01H
002B 120000      R     LCALL   L?0234
002E F500        E     MOV     extendscan+01H,A
                                           ; SOURCE LINE # 1245
0030 C4                SWAP    A
0031 540F              ANL     A,#0FH
0033 6003              JZ      ?C0182
                                           ; SOURCE LINE # 1246
                                           ; SOURCE LINE # 1247
0035 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 1248
                                           ; SOURCE LINE # 1249
0038         ?C0182:
                                           ; SOURCE LINE # 1251
0038 E500        E     MOV     A,ITempB02
003A 7014              JNZ     ?C0184
                                           ; SOURCE LINE # 1252
                                           ; SOURCE LINE # 1253
003C E500        E     MOV     A,extendscan+01H
003E 540F              ANL     A,#0FH
0040 4420              ORL     A,#020H
0042 F500        E     MOV     extendscan+01H,A
                                           ; SOURCE LINE # 1254
0044 900000      E     MOV     DPTR,#bTMcount
0047 E0                MOVX    A,@DPTR
0048 14                DEC     A
0049 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1255
004A E0                MOVX    A,@DPTR
C51 COMPILER V8.12   CORE_SCAN                                                             07/28/2018 12:03:35 PAGE 66  

004B 6003              JZ      ?C0184
                                           ; SOURCE LINE # 1256
                                           ; SOURCE LINE # 1257
004D 750001      E     MOV     ITempB02,#01H
                                           ; SOURCE LINE # 1258
                                           ; SOURCE LINE # 1259
0050         ?C0184:
                                           ; SOURCE LINE # 1261
0050 E500        E     MOV     A,ITempB02
0052 7020              JNZ     ?C0187
                                           ; SOURCE LINE # 1262
                                           ; SOURCE LINE # 1263
0054 900000      E     MOV     DPTR,#bTMrepeat
0057 E0                MOVX    A,@DPTR
0058 900000      E     MOV     DPTR,#bTMcount
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1264
005C 7800        R     MOV     R0,#LOW ?Send_EtScan2?BYTE
005E 7C00        R     MOV     R4,#HIGH ?Send_EtScan2?BYTE
0060 7D01              MOV     R5,#01H
0062 7B01              MOV     R3,#01H
0064 7A00        R     MOV     R2,#HIGH key
0066 7900        R     MOV     R1,#LOW key
0068 120000      R     LCALL   L?0233
006B 900000      R     MOV     DPTR,#?Send_EtScan2?BYTE+01H
006E 7402              MOV     A,#02H
0070 F0                MOVX    @DPTR,A
0071 120000      R     LCALL   Send_EtScan2
                                           ; SOURCE LINE # 1265
                                           ; SOURCE LINE # 1266
0074         ?C0187:
0074 22                RET     
             ; FUNCTION CheckEtKeystm (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2878    ----
   CONSTANT SIZE    =     36    ----
   XDATA SIZE       =   ----      26
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
